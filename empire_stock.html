<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Empire Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body { background: linear-gradient(-45deg, #0f172a, #1e293b, #0c1e3d, #1a1f3a); background-size: 400% 400%; animation: gradientShift 15s ease infinite; }
        .card-glow { position: relative; background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .card-glow:hover { transform: translateY(-5px); border-color: rgba(59, 130, 246, 0.5); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 30px rgba(59, 130, 246, 0.3); }
        .empire-img { transition: all 0.3s ease; filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3)); }
        .empire-img:hover { transform: scale(1.05); filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.6)); }
        .table-row { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .table-row:hover { background: rgba(59, 130, 246, 0.1); border-left-color: #3b82f6; transform: translateX(5px); }
        .shimmer-text { background: linear-gradient(90deg, #fff 0%, #60a5fa 50%, #fff 100%); background-size: 1000px 100%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shimmer 3s linear infinite; }
        .neon-border { position: relative; border: 2px solid transparent; background: linear-gradient(rgba(30, 41, 59, 0.8), rgba(30, 41, 59, 0.8)) padding-box, linear-gradient(45deg, #3b82f6, #8b5cf6, #3b82f6) border-box; }
        .leader-panel { display: flex; align-items: center; justify-content: center; gap: 0; }
        .empire-wrapper { position: relative; display: flex; align-items: center; justify-content: center; padding: 8px; border-radius: 12px; margin-right: -20px; }
        .rank-number { position: absolute; top: 10px; left: 10px; font-size: 3rem; font-weight: bold; color: #000; z-index: 10; }
        .gold-bg { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .silver-bg { background: linear-gradient(135deg, #C0C0C0, #A9A9A9); }
        .bronze-bg { background: linear-gradient(135deg, #CD7F32, #B8860B); }
        .flag-img { display: inline-block; width: 20px; height: 14px; object-fit: cover; margin-right: 8px; vertical-align: middle; }
        .name-with-flag { display: inline-flex; align-items: center; }
    </style>
</head>
<body class="min-h-screen p-8">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<div class="max-w-7xl mx-auto">
<div class="text-center mb-12">
<h1 class="text-6xl font-bold shimmer-text mb-2">Global Empire Dashboard</h1>
<p class="text-blue-400 text-lg">Real-time Market Intelligence &amp; Research Analytics</p>
<p class="text-slate-500 text-sm mt-2">Last Updated: October 19, 2025</p>
</div>
<!-- Market Cap Section -->
<div class="mb-16">
<h2 class="text-3xl font-bold text-white mb-6 text-center">
<span class="text-blue-400">üíπ</span> Market Capitalization
            </h2>
<div class="grid grid-cols-2 gap-6 mb-12">
<div class="card-glow rounded-2xl p-6"><div class="leader-panel" id="marketCapLeaderPanel"></div></div>
<div class="card-glow rounded-2xl p-6"><div class="w-full" id="marketCapPie"></div></div>
</div>
<div class="grid grid-cols-3 gap-6">
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 1.0: Steam &amp; Colonies</h3>
<span class="text-amber-400 text-sm font-bold">Top Companies</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">Company</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Cap</th>
</tr>
</thead>
<tbody class="text-white" id="marketEmpire1Table"></tbody>
</table>
</div>
</div>
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 2.0: Oil &amp; Silicon</h3>
<span class="text-blue-400 text-sm font-bold">Top Companies</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">Company</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Cap</th>
</tr>
</thead>
<tbody class="text-white" id="marketEmpire2Table"></tbody>
</table>
</div>
</div>
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 3.0: Rare Earths, Renewables &amp; Robotics</h3>
<span class="text-red-400 text-sm font-bold">Top Companies</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">Company</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Cap</th>
</tr>
</thead>
<tbody class="text-white" id="marketEmpire3Table"></tbody>
</table>
</div>
</div>
</div>
</div>
<!-- R&D Section -->
<div class="mb-16">
<h2 class="text-3xl font-bold text-white mb-6 text-center">
<span class="text-purple-400">üî¨</span> 2025 Research Leaders: Leading Countries/Institutions via Nature Index
            </h2>
<div class="grid grid-cols-2 gap-6 mb-12">
<div class="card-glow rounded-2xl p-6"><div class="leader-panel" id="researchLeaderPanel"></div></div>
<div class="card-glow rounded-2xl p-6"><div class="w-full" id="rdPie"></div></div>
</div>
<div class="grid grid-cols-3 gap-6">
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 1.0: Steam &amp; Colonies</h3>
<span class="text-amber-400 text-sm font-bold">Top Institutions</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">Institution</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Rank</th>
</tr>
</thead>
<tbody class="text-white" id="researchEmpire1Table"></tbody>
</table>
</div>
</div>
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 2.0: Oil &amp; Silicon</h3>
<span class="text-blue-400 text-sm font-bold">Top Institutions</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">Institution</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Rank</th>
</tr>
</thead>
<tbody class="text-white" id="researchEmpire2Table"></tbody>
</table>
</div>
</div>
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 3.0: Rare Earths, Renewables &amp; Robotics</h3>
<span class="text-red-400 text-sm font-bold">Top Institutions</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">Institution</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Rank</th>
</tr>
</thead>
<tbody class="text-white" id="researchEmpire3Table"></tbody>
</table>
</div>
</div>
</div>
</div>
<!-- GDP Section (kept simple) -->
<div class="mb-16">
<h2 class="text-3xl font-bold text-white mb-6 text-center">
<span class="text-green-400">üåç</span> GDP PPP (2025)
            </h2>
<div class="grid grid-cols-2 gap-6 mb-12">
<div class="card-glow rounded-2xl p-6"><div class="leader-panel" id="gdpLeaderPanel"></div></div>
<div class="card-glow rounded-2xl p-6"><div class="w-full" id="gdpPie"></div></div>
</div>
</div>
<!-- Population Section -->
<div class="mb-16">
<h2 class="text-3xl font-bold text-white mb-6 text-center">
<span class="text-yellow-400">üèôÔ∏è</span> Top Cities by Population
            </h2>
<div class="grid grid-cols-3 gap-6">
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 1.0: Steam &amp; Colonies</h3>
<span class="text-amber-400 text-sm font-bold">Top Cities</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">City</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Population</th>
</tr>
</thead>
<tbody class="text-white" id="citiesEmpire1Table"></tbody>
</table>
</div>
</div>
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 2.0: Oil &amp; Silicon</h3>
<span class="text-blue-400 text-sm font-bold">Top Cities</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">City</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Population</th>
</tr>
</thead>
<tbody class="text-white" id="citiesEmpire2Table"></tbody>
</table>
</div>
</div>
<div class="card-glow rounded-2xl p-6">
<div class="mb-4 border-b border-slate-700 pb-3">
<h3 class="text-xl font-bold text-white mb-1">Empire 3.0: Rare Earths, Renewables &amp; Robotics</h3>
<span class="text-red-400 text-sm font-bold">Top Cities</span>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead>
<tr class="border-b border-slate-700">
<th class="pb-2 text-slate-400 font-semibold text-xs">#</th>
<th class="pb-2 text-slate-400 font-semibold text-xs">City</th>
<th class="pb-2 text-slate-400 font-semibold text-xs text-right">Population</th>
</tr>
</thead>
<tbody class="text-white" id="citiesEmpire3Table"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
        let companies = [];
        let institutions = [];
        let marketCapTotals = [];
        let rdExpenditures = [];
        let gdpData = [];
        let citiesData = [];

        const empireShortNames = { 1: 'Empire 1.0: Steam & Colonies', 2: 'Empire 2.0: Oil & Silicon', 3: 'Empire 3.0: Rare Earths, Renewables & Robotics' };

        const GITHUB_BASE = 'https://raw.githubusercontent.com/ayeeff/marketcap/main/data/';

        // Minimal country name -> ISO2 lookup for common countries. Expand as needed.
        const countryNameToIso = {
            'united states': 'us', 'usa': 'us', 'united kingdom': 'gb', 'uk': 'gb', 'china': 'cn', 'peoples republic of china': 'cn', 'jp': 'jp', 'japan': 'jp', 'germany': 'de', 'france': 'fr', 'australia': 'au', 'canada': 'ca', 'india': 'in', 'russia': 'ru', 'brazil': 'br', 'south korea': 'kr', 'korea, south': 'kr', 'italy': 'it', 'spain': 'es', 'netherlands': 'nl', 'saudi arabia': 'sa', 'uae': 'ae', 'united arab emirates': 'ae', 'singapore': 'sg', 'sweden': 'se', 'switzerland': 'ch', 'norway': 'no', 'mexico': 'mx', 'indonesia': 'id', 'turkey': 'tr', 'argentina': 'ar', 'south africa': 'za', 'poland': 'pl', 'belgium': 'be', 'ireland': 'ie', 'israel': 'il', 'hong kong': 'hk', 'taiwan': 'tw', 'vietnam': 'vn', 'malaysia': 'my', 'america': 'us', 'united states of america': 'us', 'united states': 'us'
        };

        function getIsoFromCountry(countryRaw) {
            if (!countryRaw) return null;
            const c = String(countryRaw).trim();
            // If it's already 2 letters
            if (/^[A-Za-z]{2}$/.test(c)) return c.toLowerCase();
            const lower = c.toLowerCase();
            if (countryNameToIso[lower]) return countryNameToIso[lower];
            // try extracting ISO from parentheses like "(US)"
            const m = c.match(/\(([^)]+)\)/);
            if (m && /^[A-Za-z]{2}$/.test(m[1])) return m[1].toLowerCase();
            // fallback: take first two letters (best-effort)
            return c.slice(0,2).toLowerCase();
        }

        function flagUrlForCountry(countryRaw) {
            const iso = getIsoFromCountry(countryRaw);
            if (!iso) return '';
            return `https://flagcdn.com/${iso}.svg`;
        }

        async function loadData() {
            try {
                // Companies
                const companiesResponse = await fetch(GITHUB_BASE + 'empire_top_companies.csv');
                const companiesData = await companiesResponse.text();
                const companiesParsed = Papa.parse(companiesData, { header: true, skipEmptyLines: true, dynamicTyping: false });

                companies = companiesParsed.data.map(row => {
                    const companyName = (row.Company || '').split('\n')[0].trim();
                    const ticker = (row.Company || '').split('\n')[1]?.trim() || '';
                    return {
                        empire: parseInt(row.Empire),
                        name: companyName,
                        ticker: ticker,
                        marketCap: row['Market Cap'] || row.Market_Cap || '',
                        country: row.Country || row.country || row.CountryCode || row.Country_Code || ''
                    };
                });

                // Institutions
                const researchResponse = await fetch(GITHUB_BASE + 'empire_research.csv');
                const researchData = await researchResponse.text();
                const researchParsed = Papa.parse(researchData, { header: true, skipEmptyLines: true, dynamicTyping: true });

                institutions = researchParsed.data.map(row => ({
                    empire: parseInt(row.Empire),
                    rank: parseInt(row.Empire_Rank),
                    name: row.Institution,
                    globalRank: parseInt(row.Global_Rank) || null,
                    country: row.Country || row.country || row.CountryCode || row.Country_Code || ''
                }));

                // Market cap totals
                const marketCapResponse = await fetch(GITHUB_BASE + 'empire_totals.csv');
                const marketCapData = await marketCapResponse.text();
                const marketCapParsed = Papa.parse(marketCapData, { header: true, skipEmptyLines: true, dynamicTyping: false });
                marketCapTotals = marketCapParsed.data.map(row => ({ 
                    empire: parseInt(row.Empire), 
                    total: row['Total Market Cap'], 
                    share: row.Share,
                    date: row.Date 
                }));

                // R&D expenditures (Nature share)
                const rdResponse = await fetch(GITHUB_BASE + 'empire_nature_share.csv');
                const rdData = await rdResponse.text();
                const rdParsed = Papa.parse(rdData, { header: true, skipEmptyLines: true, dynamicTyping: true });
                rdExpenditures = rdParsed.data.map(row => ({ 
                    empire: parseInt(row.empire), 
                    share: parseFloat(row.share_2024), 
                    percent: parseFloat(row.percent) 
                }));

                // GDP data
                const gdpResponse = await fetch(GITHUB_BASE + 'empire_gdp_ppp_2025.csv');
                const gdpDataText = await gdpResponse.text();
                const gdpParsed = Papa.parse(gdpDataText, { header: true, skipEmptyLines: true, dynamicTyping: true });
                gdpData = gdpParsed.data.map(row => ({ 
                    empire: parseFloat(row['empire#']), 
                    total: parseFloat(row.total), 
                    percent: parseFloat(row['%']) 
                }));

                // Cities
                const citiesResponse = await fetch(GITHUB_BASE + 'empire_cities_population.csv');
                const citiesDataText = await citiesResponse.text();
                const citiesParsed = Papa.parse(citiesDataText, { header: true, skipEmptyLines: true, dynamicTyping: true });

                citiesData = citiesParsed.data.map(row => ({ 
                    empire: parseInt(row.Empire), 
                    rank: parseInt(row.Rank), 
                    city: row.City, 
                    country: row.Country, 
                    population: parseInt(row.Population), 
                    date: row.Scraped_Date 
                }));

                initDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.body.innerHTML += `<div style="color: red; text-align: center; padding: 20px;">Error loading data: ${error.message}</div>`;
            }
        }

        function createLeaderPanel(containerId, sortedData) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            sortedData.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = `empire-wrapper ${index === 0 ? 'gold-bg' : index === 1 ? 'silver-bg' : 'bronze-bg'}`;
                const rankDiv = document.createElement('div'); 
                rankDiv.className = 'rank-number'; 
                rankDiv.textContent = index + 1; 
                wrapper.appendChild(rankDiv);
                const img = document.createElement('img'); 
                img.src = `https://raw.githubusercontent.com/ayeeff/marketcap/refs/heads/main/img/emp${item.empire}.png`; 
                img.alt = `${empireShortNames[item.empire]}`; 
                img.className = 'empire-img w-72 h-72 object-contain'; 
                wrapper.appendChild(img);
                if (index < sortedData.length - 1) wrapper.style.marginRight = '-20px';
                container.appendChild(wrapper);
            });
        }

        function makeFlagImg(country) {
            const url = flagUrlForCountry(country);
            if (!url) return '';
            return `<img src="${url}" class="flag-img" alt="${country || ''}" onerror="this.style.display='none'"/>`;
        }

        function populateMarketTable(empireNum) {
            const tableBody = document.getElementById(`marketEmpire${empireNum}Table`);
            tableBody.innerHTML = '';
            const empireCompanies = companies.filter(c => c.empire === empireNum);
            empireCompanies.forEach((company, index) => {
                const flag = makeFlagImg(company.country);
                const row = document.createElement('tr');
                row.className = 'table-row border-b border-slate-700/50';
                row.innerHTML = `\n                    <td class="py-1 text-slate-300 text-xs">${index + 1}</td>\n                    <td class="py-1 text-xs break-words max-w-32"><span class=\"name-with-flag\">${flag}${company.name}</span></td>\n                    <td class="py-1 text-right font-mono text-green-400 text-xs">${company.marketCap}</td>\n                `;
                tableBody.appendChild(row);
            });
        }

        function populateResearchTable(empireNum) {
            const tableBody = document.getElementById(`researchEmpire${empireNum}Table`);
            tableBody.innerHTML = '';
            const empireInstitutions = institutions.filter(i => i.empire === empireNum);
            empireInstitutions.forEach((inst) => {
                const flag = makeFlagImg(inst.country);
                const row = document.createElement('tr');
                row.className = 'table-row border-b border-slate-700/50';
                row.innerHTML = `\n                    <td class="py-1 text-slate-300 text-xs">${inst.rank}</td>\n                    <td class="py-1 text-xs break-words max-w-32"><span class=\"name-with-flag\">${flag}${inst.name}</span></td>\n                    <td class="py-1 text-right font-mono text-purple-400 text-xs">#${inst.globalRank || '‚Äî'}</td>\n                `;
                tableBody.appendChild(row);
            });
        }

        function populateCitiesTable(empireNum) {
            const tableBody = document.getElementById(`citiesEmpire${empireNum}Table`);
            tableBody.innerHTML = '';
            const empireCities = citiesData.filter(c => c.empire === empireNum).sort((a,b)=>a.rank-b.rank).slice(0,10);
            empireCities.forEach((city) => {
                const flag = makeFlagImg(city.country);
                const row = document.createElement('tr');
                row.className = 'table-row border-b border-slate-700/50';
                row.innerHTML = `\n                    <td class="py-1 text-slate-300 text-xs">${city.rank}</td>\n                    <td class="py-1 text-xs break-words max-w-32"><span class=\"name-with-flag\">${flag}${city.city}</span></td>\n                    <td class="py-1 text-right font-mono text-yellow-400 text-xs">${city.population.toLocaleString()}</td>\n                `;
                tableBody.appendChild(row);
            });
        }

        function createInfoCard(containerId, sectionTitle, data, color) {
            const pieDiv = document.getElementById(containerId);
            const gridParent = pieDiv.parentElement;
            
            // Remove the existing pie chart container from the grid
            pieDiv.remove();
            
            // Create a new container for the info card and pie chart
            const newContainer = document.createElement('div');
            newContainer.className = 'grid grid-cols-2 gap-6';
            
            // Create info card
            const infoDiv = document.createElement('div');
            infoDiv.className = 'card-glow rounded-2xl p-6 flex flex-col justify-start';
            
            const header = document.createElement('h3');
            header.className = 'text-slate-300 font-bold mb-4';
            header.textContent = sectionTitle;
            infoDiv.appendChild(header);

            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-white';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <th class="text-slate-400 font-semibold pb-2">Empire</th>
                <th class="text-slate-400 font-semibold pb-2 text-right">Value</th>
                <th class="text-slate-400 font-semibold pb-2 text-right">Share</th>
            `;
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            // Populate table with data
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-700/50';
                tr.innerHTML = `
                    <td class="py-1">${item.name}</td>
                    <td class="py-1 text-right text-${color}-400 font-mono">${item.value}</td>
                    <td class="py-1 text-right text-slate-300">${item.percent}%</td>
                `;
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            infoDiv.appendChild(table);
            
            // Add info card and pie chart to the new container
            newContainer.appendChild(infoDiv);
            newContainer.appendChild(pieDiv);
            
            // Replace the original grid parent with our new container
            gridParent.parentNode.replaceChild(newContainer, gridParent);
            
            return newContainer;
        }

        function initDashboard() {
            const marketCapRanking = [...marketCapTotals].sort((a,b)=>{
                const aValue = parseFloat(String(a.total).replace(/[^0-9.-]+/g, '')) || 0;
                const bValue = parseFloat(String(b.total).replace(/[^0-9.-]+/g, '')) || 0;
                return bValue - aValue;
            });
            const researchRanking = [...rdExpenditures].sort((a,b)=>b.percent - a.percent);
            const gdpRanking = [...gdpData].sort((a,b)=>b.percent - a.percent);

            createLeaderPanel('marketCapLeaderPanel', marketCapRanking);
            createLeaderPanel('researchLeaderPanel', researchRanking);
            createLeaderPanel('gdpLeaderPanel', gdpRanking);

            [1,2,3].forEach(empire=>{ 
                populateMarketTable(empire); 
                populateResearchTable(empire); 
                populateCitiesTable(empire); 
            });

            // Create info cards with dynamic data
            const marketCapContainer = createInfoCard('marketCapPie', 'Market Share by Empire', marketCapTotals.map(item => ({
                name: `Empire ${item.empire}.0`,
                value: item.total,
                percent: item.share ? item.share.replace('%', '') : '0.0'
            })), 'green');

            const rdContainer = createInfoCard('rdPie', 'Research Share by Empire', rdExpenditures.map(item => ({
                name: `Empire ${item.empire}.0`,
                value: `$${item.share?.toLocaleString?.() || item.share} B`,
                percent: item.percent.toFixed(1)
            })), 'purple');

            const gdpContainer = createInfoCard('gdpPie', 'GDP Share by Empire', gdpData.map(item => ({
                name: `Empire ${item.empire}.0`,
                value: `$${item.total?.toLocaleString?.() || item.total} B`,
                percent: item.percent.toFixed(1)
            })), 'green');

            // Pie charts with updated empireShortNames
            const marketCapData = [{ 
                values: marketCapRanking.map(item=>parseFloat(String(item.total).replace(/[^0-9.-]+/g, '')) || 0), 
                labels: marketCapRanking.map(item=>`${empireShortNames[item.empire]}\n${item.total}`), 
                type: 'pie', 
                marker: { 
                    colors: marketCapRanking.map(item=> item.empire===1? '#f59e0b' : item.empire===2? '#3b82f6' : item.empire===3? '#ef4444' : '#6b7280'), 
                    line: { color: '#1e293b', width: 2 } 
                }, 
                textinfo: 'none', 
                textposition: 'inside', 
                textfont: { size: 13, color: '#ffffff', family: 'sans-serif' }, 
                hovertemplate: '<b>%{label}</b><br>%{percent}<extra></extra>' 
            }];
            
            const rdData = [{ 
                values: researchRanking.map(item=>item.share), 
                labels: researchRanking.map(item=>`${empireShortNames[item.empire]}\n$${item.share?.toLocaleString?.()||item.share}B (${item.percent}%)`), 
                type: 'pie', 
                marker: { 
                    colors: researchRanking.map(item=> item.empire===1? '#f59e0b' : item.empire===2? '#3b82f6' : item.empire===3? '#ef4444' : '#6b7280'), 
                    line: { color: '#1e293b', width: 2 } 
                }, 
                textinfo: 'none', 
                textposition: 'inside', 
                textfont: { size: 12, color: '#ffffff', family: 'sans-serif' }, 
                hovertemplate: '<b>%{label}</b><extra></extra>' 
            }];
            
            const gdpDataChart = [{ 
                values: gdpRanking.map(item=>item.total), 
                labels: gdpRanking.map(item=>`${empireShortNames[item.empire]}\n$${item.total?.toLocaleString?.()||item.total}B (${item.percent}%)`), 
                type: 'pie', 
                marker: { 
                    colors: gdpRanking.map(item=> item.empire===1? '#f59e0b' : item.empire===2? '#3b82f6' : item.empire===3? '#ef4444' : '#6b7280'), 
                    line: { color: '#1e293b', width: 2 } 
                }, 
                textinfo: 'none', 
                textposition: 'inside', 
                textfont: { size: 12, color: '#ffffff', family: 'sans-serif' }, 
                hovertemplate: '<b>%{label}</b><extra></extra>' 
            }];

            const layout = { 
                paper_bgcolor: 'rgba(0,0,0,0)', 
                plot_bgcolor: 'rgba(0,0,0,0)', 
                showlegend: false, 
                margin: {t:10,b:10,l:10,r:10}, 
                height: 280 
            };
            const config = { responsive: true, displayModeBar: false };
            
            // Plot the charts in their new containers
            Plotly.newPlot(marketCapContainer.querySelector('#marketCapPie'), marketCapData, layout, config);
            Plotly.newPlot(rdContainer.querySelector('#rdPie'), rdData, layout, config);
            Plotly.newPlot(gdpContainer.querySelector('#gdpPie'), gdpDataChart, layout, config);
        }

        // Start loading data
        loadData();
    </script>
</body>
</html>
