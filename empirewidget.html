<style>
  .map-container-empire {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #f0f0f0;
    height: 60vh; /* Adjust as needed */
  }
  .container-empire {
    width: 80%;
    height: 100%;
    max-width: 80%;
  }
  svg {
    display: block;
    width: 100%;
    height: 100%;
    background: white;
  }
  .label {
    fill: black;
    font-weight: bold;
    text-anchor: start;
    dominant-baseline: central;
  }
  #tooltip-empire {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px;
    border-radius: 4px;
    pointer-events: none;
    opacity: 0;
    font-size: 12px;
    z-index: 1000;
  }
</style>

<div class="map-container-empire" id="second-map">
  <div class="container-empire">
    <svg viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid meet"></svg>
  </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  (function() {  // IIFE to scope to this widget
    // Hardcoded tooltips for empires (rank 1-3)
    const empireTooltips = [
      '1,Empire 1.0: Steam & Colonies,British Commonwealth,$12.26 T,21,8.28%,11.65%',
      '2,Empire 2.0: Oil & Silicon,United States,$68.89 T,1,46.50%,65.42%',
      '3,"Empire 3.0: Rare Earths, Renewables & Robotics",China + Hong Kong + Taiwan,$24.15 T,3,16.30%,22.93%'
    ];

    const cacheBust = Date.now();

    // Adapted createTreemap for empire only
    function createTreemapEmpire(svgSelector, data) {
      const root = d3.hierarchy({children: data})
        .sum(d => d.perc)
        .sort((a, b) => b.value - a.value);

      const viewWidth = 1200;
      const viewHeight = 800;

      const svg = d3.select(svgSelector);

      const treemap = d3.treemap()
        .size([viewWidth, viewHeight])
        .padding(1)
        .round(true);

      treemap(root);

      const leaf = svg.selectAll("g")
        .data(root.leaves())
        .join("g")
        .attr("transform", d => `translate(${Math.round(d.x0)}, ${Math.round(d.y0)})`);

      leaf.append("rect")
        .attr("width", d => Math.max(1, Math.round(d.x1 - d.x0)))
        .attr("height", d => Math.max(1, Math.round(d.y1 - d.y0)))
        .attr("fill", "none")
        .style("stroke", "#000")
        .style("stroke-width", 0.5);

      leaf.append("image")
        .attr("xlink:href", d => {
          const rank = +d.data.Rank;
          return `https://raw.githubusercontent.com/ayeeff/marketcap/main/img/emp${rank}.png?v=${cacheBust}`;
        })
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", d => Math.max(1, Math.round(d.x1 - d.x0)))
        .attr("height", d => Math.max(1, Math.round(d.y1 - d.y0)))
        .attr("preserveAspectRatio", "none");

      // Labels
      const text = leaf.append("text")
        .attr("font-size", d => Math.min((d.x1 - d.x0) / 8, (d.y1 - d.y0) / 8, 12))
        .attr("fill", "black")
        .classed("label", true);

      text.append("tspan")
        .attr("x", 2)
        .attr("y", 12)
        .text(d => {
          const name = d.data.Empire;
          const shortName = name.length > 10 ? name.substring(0, 10) + '...' : name;
          return shortName;
        });

      // Tooltip for empire
      let tooltip = d3.select("#tooltip-empire");
      if (tooltip.empty()) {
        tooltip = d3.select("body").append("div")
          .attr("id", "tooltip-empire")
          .style("position", "absolute")
          .style("background", "rgba(0, 0, 0, 0.8)")
          .style("color", "white")
          .style("padding", "8px")
          .style("border-radius", "4px")
          .style("pointer-events", "none")
          .style("opacity", 0)
          .style("font-size", "12px")
          .style("z-index", 1000);
      }

      leaf.on("mouseover", (event, d) => {
        const rect = event.currentTarget.querySelector("rect");
        d3.select(rect).style("stroke-width", 2);
        const rank = +d.data.Rank;
        const tooltipText = empireTooltips[rank - 1] || "Unknown Empire";
        tooltip.style("opacity", 1)
          .html(tooltipText)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 28) + "px");
      }).on("mouseout", (event) => {
        const rect = event.currentTarget.querySelector("rect");
        d3.select(rect).style("stroke-width", 0.5);
        tooltip.style("opacity", 0);
      });
    }

    // Load empire data
    d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/empire_marketcap.csv?v=${cacheBust}`).then(empData => {
      empData.forEach(d => {
        let percStr = d["% of Empire Total"].toString().replace('%', '').trim();
        d.perc = +percStr;
      });
      const filteredEmp = empData.filter(d => +d.Rank <= 3 && !isNaN(d.perc));
      createTreemapEmpire("#second-map .container-empire svg", filteredEmp);
    }).catch(error => {
      console.error("Error loading empire CSV:", error);
    });
  })();
</script>
