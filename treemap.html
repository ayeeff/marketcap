<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Global Market Cap & Economic Treemaps</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
        }
        .map-container {
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f0f0f0;
        }
        #first-map, #second-map, #third-map, #fourth-map {
            height: 25vh;
        }
        .container {
            width: 80vw;
            height: 100%;
            max-width: 80vw;
        }
        svg {
            display: block;
            width: 100%;
            height: 100%;
            background: white;
        }
        .label {
            fill: black;
            font-weight: bold;
            text-anchor: start;
            dominant-baseline: central;
        }
    </style>
</head>
<body>
    <div class="map-container" id="first-map">
        <div class="container">
            <svg viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid meet"></svg>
        </div>
    </div>
    <div class="map-container" id="second-map">
        <div class="container">
            <svg viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid meet"></svg>
        </div>
    </div>
    <div class="map-container" id="third-map">
        <div class="container">
            <svg viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid meet"></svg>
        </div>
    </div>
    <div class="map-container" id="fourth-map">
        <div class="container">
            <svg viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid meet"></svg>
        </div>
    </div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const countryToISO = {
            "Afghanistan": "af",
            "Aland Islands": "ax",
            "Albania": "al",
            "Algeria": "dz",
            "American Samoa": "as",
            "Andorra": "ad",
            "Angola": "ao",
            "Anguilla": "ai",
            "Antarctica": "aq",
            "Antigua And Barbuda": "ag",
            "Argentina": "ar",
            "Armenia": "am",
            "Aruba": "aw",
            "Australia": "au",
            "Austria": "at",
            "Azerbaijan": "az",
            "Bahamas": "bs",
            "Bahrain": "bh",
            "Bangladesh": "bd",
            "Barbados": "bb",
            "Belarus": "by",
            "Belgium": "be",
            "Belize": "bz",
            "Benin": "bj",
            "Bermuda": "bm",
            "Bhutan": "bt",
            "Bolivia": "bo",
            "Bosnia And Herzegovina": "ba",
            "Botswana": "bw",
            "Bouvet Island": "bv",
            "Brazil": "br",
            "British Indian Ocean Territory": "io",
            "Brunei Darussalam": "bn",
            "Bulgaria": "bg",
            "Burkina Faso": "bf",
            "Burundi": "bi",
            "Cambodia": "kh",
            "Cameroon": "cm",
            "Canada": "ca",
            "Cape Verde": "cv",
            "Cayman Islands": "ky",
            "Central African Republic": "cf",
            "Chad": "td",
            "Chile": "cl",
            "China": "cn",
            "Christmas Island": "cx",
            "Cocos (Keeling) Islands": "cc",
            "Colombia": "co",
            "Comoros": "km",
            "Congo": "cg",
            "Congo, Democratic Republic": "cd",
            "Cook Islands": "ck",
            "Costa Rica": "cr",
            "Cote D' Ivoire": "ci",
            "Croatia": "hr",
            "Cuba": "cu",
            "Cyprus": "cy",
            "Czech Republic": "cz",
            "Denmark": "dk",
            "Djibouti": "dj",
            "Dominica": "dm",
            "Dominican Republic": "do",
            "Ecuador": "ec",
            "Egypt": "eg",
            "El Salvador": "sv",
            "Equatorial Guinea": "gq",
            "Eritrea": "er",
            "Estonia": "ee",
            "Ethiopia": "et",
            "Falkland Islands (Malvinas)": "fk",
            "Faroe Islands": "fo",
            "Fiji": "fj",
            "Finland": "fi",
            "France": "fr",
            "French Guiana": "gf",
            "French Polynesia": "pf",
            "French Southern Territories": "tf",
            "Gabon": "ga",
            "Gambia": "gm",
            "Georgia": "ge",
            "Germany": "de",
            "Ghana": "gh",
            "Gibraltar": "gi",
            "Greece": "gr",
            "Greenland": "gl",
            "Grenada": "gd",
            "Guadeloupe": "gp",
            "Guam": "gu",
            "Guatemala": "gt",
            "Guernsey": "gg",
            "Guinea": "gn",
            "Guinea-Bissau": "gw",
            "Guyana": "gy",
            "Haiti": "ht",
            "Heard Island & Mcdonald Islands": "hm",
            "Holy See (Vatican City State)": "va",
            "Honduras": "hn",
            "Hong Kong": "hk",
            "Hungary": "hu",
            "Iceland": "is",
            "India": "in",
            "Indonesia": "id",
            "Iran, Islamic Republic Of": "ir",
            "Iraq": "iq",
            "Ireland": "ie",
            "Isle Of Man": "im",
            "Israel": "il",
            "Italy": "it",
            "Jamaica": "jm",
            "Japan": "jp",
            "Jersey": "je",
            "Jordan": "jo",
            "Kazakhstan": "kz",
            "Kenya": "ke",
            "Kiribati": "ki",
            "Korea": "kr",
            "Kuwait": "kw",
            "Kyrgyzstan": "kg",
            "Lao People's Democratic Republic": "la",
            "Latvia": "lv",
            "Lebanon": "lb",
            "Lesotho": "ls",
            "Liberia": "lr",
            "Libyan Arab Jamahiriya": "ly",
            "Liechtenstein": "li",
            "Lithuania": "lt",
            "Luxembourg": "lu",
            "Macao": "mo",
            "Macedonia": "mk",
            "Madagascar": "mg",
            "Malawi": "mw",
            "Malaysia": "my",
            "Maldives": "mv",
            "Mali": "ml",
            "Malta": "mt",
            "Marshall Islands": "mh",
            "Martinique": "mq",
            "Mauritania": "mr",
            "Mauritius": "mu",
            "Mayotte": "yt",
            "Mexico": "mx",
            "Micronesia, Federated States Of": "fm",
            "Moldova": "md",
            "Monaco": "mc",
            "Mongolia": "mn",
            "Montenegro": "me",
            "Montserrat": "ms",
            "Morocco": "ma",
            "Mozambique": "mz",
            "Myanmar": "mm",
            "Namibia": "na",
            "Nauru": "nr",
            "Nepal": "np",
            "Netherlands": "nl",
            "Netherlands Antilles": "an",
            "New Caledonia": "nc",
            "New Zealand": "nz",
            "Nicaragua": "ni",
            "Niger": "ne",
            "Nigeria": "ng",
            "Niue": "nu",
            "Norfolk Island": "nf",
            "Northern Mariana Islands": "mp",
            "Norway": "no",
            "Oman": "om",
            "Pakistan": "pk",
            "Palau": "pw",
            "Palestinian Territory, Occupied": "ps",
            "Panama": "pa",
            "Papua New Guinea": "pg",
            "Paraguay": "py",
            "Peru": "pe",
            "Philippines": "ph",
            "Pitcairn": "pn",
            "Poland": "pl",
            "Portugal": "pt",
            "Puerto Rico": "pr",
            "Qatar": "qa",
            "Reunion": "re",
            "Romania": "ro",
            "Russian Federation": "ru",
            "Rwanda": "rw",
            "Saint Barthelemy": "bl",
            "Saint Helena": "sh",
            "Saint Kitts And Nevis": "kn",
            "Saint Lucia": "lc",
            "Saint Martin": "mf",
            "Saint Pierre And Miquelon": "pm",
            "Saint Vincent And Grenadines": "vc",
            "Samoa": "ws",
            "San Marino": "sm",
            "Sao Tome And Principe": "st",
            "Saudi Arabia": "sa",
            "Senegal": "sn",
            "Serbia": "rs",
            "Seychelles": "sc",
            "Sierra Leone": "sl",
            "Singapore": "sg",
            "Slovakia": "sk",
            "Slovenia": "si",
            "Solomon Islands": "sb",
            "Somalia": "so",
            "South Africa": "za",
            "South Georgia And Sandwich Isl.": "gs",
            "Spain": "es",
            "Sri Lanka": "lk",
            "Sudan": "sd",
            "Suriname": "sr",
            "Svalbard And Jan Mayen": "sj",
            "Swaziland": "sz",
            "Sweden": "se",
            "Switzerland": "ch",
            "Syrian Arab Republic": "sy",
            "Taiwan": "tw",
            "Tajikistan": "tj",
            "Tanzania": "tz",
            "Thailand": "th",
            "Timor-Leste": "tl",
            "Togo": "tg",
            "Tokelau": "tk",
            "Tonga": "to",
            "Trinidad And Tobago": "tt",
            "Tunisia": "tn",
            "Turkey": "tr",
            "Turkmenistan": "tm",
            "Turks And Caicos Islands": "tc",
            "Tuvalu": "tv",
            "Uganda": "ug",
            "Ukraine": "ua",
            "United Arab Emirates": "ae",
            "United Kingdom": "gb",
            "United States": "us",
            "United States Outlying Islands": "um",
            "Uruguay": "uy",
            "Uzbekistan": "uz",
            "Vanuatu": "vu",
            "Venezuela": "ve",
            "Viet Nam": "vn",
            "Virgin Islands, British": "vg",
            "Virgin Islands, U.S.": "vi",
            "Wallis And Futuna": "wf",
            "Western Sahara": "eh",
            "Yemen": "ye",
            "Zambia": "zm",
            "Zimbabwe": "zw"
        };

        // Add aliases for variations in CSV
        countryToISO["South Korea"] = "kr";
        countryToISO["Russia"] = "ru";
        countryToISO["Vietnam"] = "vn";
        countryToISO["Ivory Coast"] = "ci";
        countryToISO["Palestine"] = "ps";
        countryToISO["Eswatini"] = "sz"; // Formerly Swaziland

        // Cache-busting timestamp
        const cacheBust = Date.now();

        // Empire descriptions (hardcoded for consistency)
        const empireDescriptions = {
            '1.0': { empire: 'Empire 1.0: Steam & Colonies', desc: 'British Commonwealth', totalLabel: 'Total Market Cap' },
            '2.0': { empire: 'Empire 2.0: Oil & Silicon', desc: 'United States', totalLabel: 'Total Market Cap' },
            '3.0': { empire: 'Empire 3.0: Rare Earths, Renewables & Robotics', desc: 'China + Hong Kong + Taiwan', totalLabel: 'Total Market Cap' }
        };

        // Function to create treemap
        function createTreemap(svgSelector, data, isEmpire = false, totalLabel = 'Total') {
            const root = d3.hierarchy({children: data})
                .sum(d => d.perc)
                .sort((a, b) => b.value - a.value);

            const viewWidth = 1200;
            const viewHeight = 800;

            const svg = d3.select(svgSelector);

            const treemap = d3.treemap()
                .size([viewWidth, viewHeight])
                .padding(1)
                .round(true);

            treemap(root);

            const leaf = svg.selectAll("g")
                .data(root.leaves())
                .join("g")
                .attr("transform", d => `translate(${Math.round(d.x0)}, ${Math.round(d.y0)})`);

            leaf.append("rect")
                .attr("width", d => Math.max(1, Math.round(d.x1 - d.x0)))
                .attr("height", d => Math.max(1, Math.round(d.y1 - d.y0)))
                .attr("fill", "none")
                .style("stroke", "#000")
                .style("stroke-width", 0.5);

            leaf.append("image")
                .attr("xlink:href", d => {
                    if (isEmpire) {
                        const rank = d.data['empire#'] || d.data.Rank;
                        return `https://raw.githubusercontent.com/ayeeff/marketcap/main/img/emp${rank || 1}.png?v=${cacheBust}`;
                    } else {
                        const country = d.data["Country or region"];
                        let iso = countryToISO[country];
                        if (!iso) {
                            if (country === "South Korea") iso = "kr";
                            else if (country === "Russia") iso = "ru";
                            else if (country === "Vietnam") iso = "vn";
                            else if (country === "Ivory Coast") iso = "ci";
                            else if (country === "Palestine") iso = "ps";
                            else return null; // or default color
                        }
                        return `https://flagcdn.com/w320/${iso}.png`; // Larger for better quality
                    }
                })
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", d => Math.max(1, Math.round(d.x1 - d.x0)))
                .attr("height", d => Math.max(1, Math.round(d.y1 - d.y0)))
                .attr("preserveAspectRatio", "none");

            // Labels
            const text = leaf.append("text")
                .attr("font-size", d => Math.min((d.x1 - d.x0) / 8, (d.y1 - d.y0) / 8, 12))
                .attr("fill", "black")
                .classed("label", true);

            text.append("tspan")
                .attr("x", 2)
                .attr("y", 12)
                .text(d => {
                    const name = isEmpire ? d.data.Empire : d.data["Country or region"];
                    const shortName = name.length > 10 ? name.substring(0, 10) + '...' : name;
                    return shortName;
                });

            // Tooltip (shared, but per map)
            const tooltipId = isEmpire ? 'tooltip-emp' : 'tooltip-global';
            let tooltip = d3.select(`#${tooltipId}`);
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("id", tooltipId)
                    .style("position", "absolute")
                    .style("background", "rgba(0, 0, 0, 0.8)")
                    .style("color", "white")
                    .style("padding", "8px")
                    .style("border-radius", "4px")
                    .style("pointer-events", "none")
                    .style("opacity", 0)
                    .style("font-size", "12px")
                    .style("z-index", 1000);
            }

            leaf.on("mouseover", (event, d) => {
                const rect = event.currentTarget.querySelector("rect");
                d3.select(rect).style("stroke-width", 2);
                if (isEmpire) {
                    tooltip.style("opacity", 1)
                        .html(`${d.data.Empire}<br/>${d.data.Description}<br/>${d.data.Total}<br/>${d.data.perc.toFixed(2)}% of Combined`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                } else {
                    const name = d.data["Country or region"];
                    const cap = d.data["Total MarketCap"];
                    tooltip.style("opacity", 1)
                        .html(`${name}<br/>${cap}<br/>${d.data.perc.toFixed(2)}%`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                }
            }).on("mouseout", (event) => {
                const rect = event.currentTarget.querySelector("rect");
                d3.select(rect).style("stroke-width", 0.5);
                tooltip.style("opacity", 0);
            });
        }

        // Load global data for first map
        d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/countries_marketcap.csv?v=${cacheBust}`).then(globalData => {
            console.log("Global data loaded:", globalData.length, "rows");
            globalData.forEach(d => {
                d.perc = +d["% of Global Market Cap"];
            });

            // Filter to only countries with positive %, and sort
            const filteredGlobal = globalData.filter(d => d.perc > 0).sort((a, b) => b.perc - a.perc);
            console.log("Filtered global data:", filteredGlobal.length, "rows");

            // Create first map
            createTreemap("#first-map .container svg", filteredGlobal, false);

            // Load empire data for second map
            d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/empire_marketcap.csv?v=${cacheBust}`).then(empData => {
                console.log("Empire data loaded:", empData.length, "rows");
                empData.forEach(d => {
                    // Parse percentage, removing % if present
                    let percStr = d["% of Empire Total"].toString().replace('%', '').trim();
                    d.perc = +percStr;
                    console.log(`Empire ${d.Rank}: ${d["% of Empire Total"]} -> ${d.perc}`);
                });

                // Filter to ranks 1-3
                const filteredEmp = empData.filter(d => +d.Rank <= 3 && !isNaN(d.perc)).sort((a, b) => +a.Rank - +b.Rank);

                // Create second map
                createTreemap("#second-map .container svg", filteredEmp, true, 'Total Market Cap');
            }).catch(error => {
                console.error("Error loading empire CSV:", error);
                d3.select("body").append("p").text("Error loading empire data. Check console.");
            });

            // Load GDP PPP data for third map
            d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/empire_gdp_ppp_2025.csv?v=${cacheBust}`).then(gdpData => {
                console.log("GDP data loaded:", gdpData.length, "rows");
                gdpData.forEach(d => {
                    d.perc = +d['%'];
                    const num = d['empire#'];
                    const desc = empireDescriptions[num];
                    if (desc) {
                        d.Empire = desc.empire;
                        d.Description = desc.desc;
                        d.Total = `${d.total}B PPP`;
                    }
                });

                // Create third map
                createTreemap("#third-map .container svg", gdpData, true, 'Total GDP PPP');
            }).catch(error => {
                console.error("Error loading GDP CSV:", error);
                d3.select("body").append("p").text("Error loading GDP data. Check console.");
            });

            // Load R&D data for fourth map
            d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/empire_rd_expenditure_latest.csv?v=${cacheBust}`).then(rdData => {
                console.log("R&D data loaded:", rdData.length, "rows");
                rdData.forEach(d => {
                    d.perc = +d['%'];
                    const num = d['empire#'];
                    const desc = empireDescriptions[num];
                    if (desc) {
                        d.Empire = desc.empire;
                        d.Description = desc.desc;
                        d.Total = `${d.total}B USD`;
                    }
                });

                // Create fourth map
                createTreemap("#fourth-map .container svg", rdData, true, 'Total R&D');
            }).catch(error => {
                console.error("Error loading R&D CSV:", error);
                d3.select("body").append("p").text("Error loading R&D data. Check console.");
            });

        }).catch(error => {
            console.error("Error loading global CSV:", error);
            d3.select("body").append("p").text("Error loading global data. Check console.");
        });
    </script>
</body>
</html>
