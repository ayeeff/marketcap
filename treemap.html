<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Market Cap Treemap</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .country-cell {
            position: absolute;
            border: 2px solid #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        
        .country-cell:hover {
            border-color: #fff;
            z-index: 1000;
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        
        .country-ticker {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .country-value {
            font-size: 13px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .country-change {
            font-size: 16px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .country-percent {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .flag {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        #file-input-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
        }
        
        #file-input {
            padding: 10px 20px;
            background: #333;
            border: 2px solid #555;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        
        #title {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        #stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 2000;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            z-index: 3000;
        }
    </style>
</head>
<body>
    <div id="title">Global Stock Market Cap by Country</div>
    <div id="file-input-container">
        <input type="file" id="file-input" accept=".csv" />
    </div>
    <div id="loading">Loading data...</div>
    <div id="container"></div>
    <div id="stats"></div>

    <script>
        // Country flags mapping
        const countryFlags = {
            'United States': '🇺🇸', 'US': '🇺🇸', 'USA': '🇺🇸',
            'China': '🇨🇳', 'CN': '🇨🇳',
            'Japan': '🇯🇵', 'JP': '🇯🇵',
            'United Kingdom': '🇬🇧', 'UK': '🇬🇧', 'GB': '🇬🇧',
            'India': '🇮🇳', 'IN': '🇮🇳',
            'France': '🇫🇷', 'FR': '🇫🇷',
            'Canada': '🇨🇦', 'CA': '🇨🇦',
            'Germany': '🇩🇪', 'DE': '🇩🇪',
            'Hong Kong': '🇭🇰', 'HK': '🇭🇰',
            'Australia': '🇦🇺', 'AU': '🇦🇺',
            'South Korea': '🇰🇷', 'KR': '🇰🇷', 'Korea': '🇰🇷',
            'Switzerland': '🇨🇭', 'CH': '🇨🇭',
            'Taiwan': '🇹🇼', 'TW': '🇹🇼',
            'Netherlands': '🇳🇱', 'NL': '🇳🇱',
            'Sweden': '🇸🇪', 'SE': '🇸🇪',
            'Spain': '🇪🇸', 'ES': '🇪🇸',
            'Italy': '🇮🇹', 'IT': '🇮🇹',
            'Singapore': '🇸🇬', 'SG': '🇸🇬',
            'Brazil': '🇧🇷', 'BR': '🇧🇷',
            'Denmark': '🇩🇰', 'DK': '🇩🇰',
            'Belgium': '🇧🇪', 'BE': '🇧🇪',
            'Saudi Arabia': '🇸🇦', 'SA': '🇸🇦',
            'South Africa': '🇿🇦', 'ZA': '🇿🇦',
            'Mexico': '🇲🇽', 'MX': '🇲🇽',
            'Thailand': '🇹🇭', 'TH': '🇹🇭',
            'Norway': '🇳🇴', 'NO': '🇳🇴',
            'Finland': '🇫🇮', 'FI': '🇫🇮',
            'Poland': '🇵🇱', 'PL': '🇵🇱',
            'Israel': '🇮🇱', 'IL': '🇮🇱',
            'UAE': '🇦🇪', 'United Arab Emirates': '🇦🇪',
            'Ireland': '🇮🇪', 'IE': '🇮🇪',
        };

        function getFlag(country) {
            return countryFlags[country] || '🌐';
        }

        function getColor(change) {
            if (!change || change === '-' || change === '') return '#666';
            
            const changeStr = String(change).replace('%', '').trim();
            const percent = parseFloat(changeStr);
            if (isNaN(percent)) return '#666';
            
            if (percent > 5) return '#006400';
            if (percent > 2) return '#228B22';
            if (percent > 0) return '#32CD32';
            if (percent > -2) return '#DC143C';
            if (percent > -5) return '#8B0000';
            return '#4d0000';
        }

        function parseMarketCap(value) {
            if (!value || value === '-') return 0;
            
            // Remove dollar sign and commas
            value = String(value).replace('

        function formatMarketCap(value) {
            if (value >= 1000000000000) {
                return '$' + (value / 1000000000000).toFixed(2) + 'T';
            } else if (value >= 1000000000) {
                return '$' + (value / 1000000000).toFixed(2) + 'B';
            } else if (value >= 1000000) {
                return '$' + (value / 1000000).toFixed(2) + 'M';
            }
            return '$' + value.toFixed(0);
        }

        // Simple treemap algorithm (squarified)
        function squarify(data, x, y, width, height) {
            const total = data.reduce((sum, d) => sum + d.value, 0);
            
            function layoutRow(row, x, y, width, height) {
                const rowTotal = row.reduce((sum, d) => sum + d.value, 0);
                const rowRatio = rowTotal / total;
                
                if (width >= height) {
                    // Horizontal layout
                    const rowWidth = width * rowRatio;
                    let currentY = y;
                    row.forEach(item => {
                        const itemHeight = height * (item.value / rowTotal);
                        item.bounds = { x, y: currentY, width: rowWidth, height: itemHeight };
                        currentY += itemHeight;
                    });
                    return { x: x + rowWidth, y, width: width - rowWidth, height };
                } else {
                    // Vertical layout
                    const rowHeight = height * rowRatio;
                    let currentX = x;
                    row.forEach(item => {
                        const itemWidth = width * (item.value / rowTotal);
                        item.bounds = { x: currentX, y, width: itemWidth, height: rowHeight };
                        currentX += itemWidth;
                    });
                    return { x, y: y + rowHeight, width, height: height - rowHeight };
                }
            }

            const sorted = [...data].sort((a, b) => b.value - a.value);
            let remaining = { x, y, width, height };
            
            for (let i = 0; i < sorted.length; i++) {
                const item = sorted[i];
                item.bounds = { x: remaining.x, y: remaining.y, width: remaining.width, height: remaining.height };
                
                if (i < sorted.length - 1) {
                    remaining = layoutRow([item], remaining.x, remaining.y, remaining.width, remaining.height);
                }
            }
            
            return sorted;
        }

        function createTreemap(csvData) {
            document.getElementById('loading').style.display = 'none';
            const container = document.getElementById('container');
            container.innerHTML = '';
            
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            console.log('CSV Data received:', csvData);
            console.log('First row:', csvData[0]);
            console.log('Available columns:', Object.keys(csvData[0] || {}));
            
            // Find column names (case insensitive)
            const firstRow = csvData[0] || {};
            const cols = Object.keys(firstRow);
            
            const countryCol = cols.find(c => c.toLowerCase().includes('country')) || cols[0];
            const marketCapCol = cols.find(c => c.toLowerCase().includes('marketcap') || (c.toLowerCase().includes('market') && c.toLowerCase().includes('cap')));
            const changeCol = cols.find(c => c.toLowerCase().includes('change') || c.toLowerCase().includes('1d'));
            const percentCol = cols.find(c => c.includes('%') || c.toLowerCase().includes('percent') || c.toLowerCase().includes('global'));
            
            console.log('Detected columns:', { countryCol, marketCapCol, changeCol, percentCol });
            
            // Process data
            const processedData = csvData.map(d => {
                const marketCapValue = parseMarketCap(d[marketCapCol] || '0');
                
                // Get percentage from CSV column
                let percentValue = parseFloat(d[percentCol] || '0');
                
                return {
                    country: d[countryCol] || 'Unknown',
                    marketCap: marketCapValue,
                    change: d[changeCol] || '0%',
                    percent: percentValue,
                    value: percentValue  // USE PERCENTAGE FOR SIZING, not market cap!
                };
            }).filter(d => d.marketCap > 0 && d.percent > 0);
            
            console.log('Processed Data:', processedData);
            console.log('Valid countries:', processedData.length);
            
            if (processedData.length === 0) {
                container.innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;">No valid data found in CSV</div>';
                return;
            }
            
            // Create treemap
            const laid = squarify(processedData, 0, 0, width, height);
            
            // Create cells
            laid.forEach(d => {
                const cell = document.createElement('div');
                cell.className = 'country-cell';
                
                const bounds = d.bounds;
                cell.style.left = bounds.x + 'px';
                cell.style.top = bounds.y + 'px';
                cell.style.width = bounds.width + 'px';
                cell.style.height = bounds.height + 'px';
                cell.style.backgroundColor = getColor(d.change);
                
                const minDim = Math.min(bounds.width, bounds.height);
                const showDetails = minDim > 60;
                const showTicker = minDim > 40;
                
                let content = '';
                
                if (showDetails) {
                    content = `
                        <div class="flag">${getFlag(d.country)}</div>
                        <div class="country-ticker">${d.country.substring(0, 4).toUpperCase()}</div>
                        <div class="country-change">${d.change}</div>
                        <div class="country-value">${formatMarketCap(d.marketCap)}</div>
                        <div class="country-percent">${d.percent.toFixed(2)}%</div>
                    `;
                } else if (showTicker) {
                    content = `
                        <div class="country-ticker" style="font-size: ${Math.max(minDim * 0.25, 10)}px">${d.country.substring(0, 3)}</div>
                        <div class="country-change" style="font-size: ${Math.max(minDim * 0.2, 8)}px">${d.change}</div>
                    `;
                } else {
                    content = `<div style="font-size: ${Math.max(minDim * 0.3, 8)}px">${d.country.substring(0, 2)}</div>`;
                }
                
                cell.innerHTML = content;
                
                cell.addEventListener('click', () => {
                    alert(`${d.country}\nMarket Cap: ${formatMarketCap(d.marketCap)}\nChange: ${d.change}\nGlobal Share: ${d.percent.toFixed(2)}%`);
                });
                
                container.appendChild(cell);
            });
            
            // Update stats
            const total = processedData.reduce((sum, d) => sum + d.marketCap, 0);
            const avgChange = processedData.reduce((sum, d) => {
                const change = parseFloat(String(d.change).replace('%', ''));
                return sum + (isNaN(change) ? 0 : change);
            }, 0) / processedData.length;
            
            document.getElementById('stats').innerHTML = `
                <strong>Global Market Cap:</strong> ${formatMarketCap(total)}<br>
                <strong>Countries:</strong> ${processedData.length}<br>
                <strong>Avg Change:</strong> ${avgChange.toFixed(2)}%
            `;
        }

        // Simple CSV parser
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = values[i] || '';
                });
                return obj;
            });
        }

        // File upload handler
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const csvData = parseCSV(event.target.result);
                createTreemap(csvData);
            };
            reader.readAsText(file);
        });

        // Auto-load CSV - try multiple methods
        
        // Method 1: Try relative path (works if hosted on GitHub Pages)
        fetch('./data/countries_marketcap.csv')
            .then(response => {
                if (!response.ok) throw new Error('Relative path failed');
                console.log('Loaded via relative path');
                return response.text();
            })
            .then(csvText => {
                const csvData = parseCSV(csvText);
                createTreemap(csvData);
            })
            .catch(error1 => {
                console.log('Relative path failed, trying CDN...');
                
                // Method 2: Try jsdelivr CDN
                fetch('https://cdn.jsdelivr.net/gh/ayeeff/marketcap@main/data/countries_marketcap.csv')
                    .then(response => {
                        if (!response.ok) throw new Error('CDN failed');
                        console.log('Loaded via jsdelivr CDN');
                        return response.text();
                    })
                    .then(csvText => {
                        const csvData = parseCSV(csvText);
                        createTreemap(csvData);
                    })
                    .catch(error2 => {
                        console.log('CDN failed, trying CORS proxy...');
                        
                        // Method 3: Try with CORS proxy
                        fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://raw.githubusercontent.com/ayeeff/marketcap/main/data/countries_marketcap.csv'))
                            .then(response => response.text())
                            .then(csvText => {
                                console.log('Loaded via CORS proxy');
                                const csvData = parseCSV(csvText);
                                createTreemap(csvData);
                            })
                            .catch(error3 => {
                                console.error('All methods failed');
                                document.getElementById('loading').innerHTML = 
                                    '<strong>Could not auto-load data from GitHub.</strong><br><br>' +
                                    'Please upload CSV file using button above.<br><br>' +
                                    '<small>Make sure this HTML is hosted on GitHub Pages,<br>' +
                                    'or use the file upload button.</small>';
                            });
                    });
            });
    </script>
</body>
</html>, '').replace(/,/g, '').trim();
            let multiplier = 1;
            
            // Check for T, B, M (case insensitive)
            const upperValue = value.toUpperCase();
            if (upperValue.includes('T')) {
                multiplier = 1000000000000;  // Trillion
                value = upperValue.replace('T', '').trim();
            } else if (upperValue.includes('B')) {
                multiplier = 1000000000;  // Billion
                value = upperValue.replace('B', '').trim();
            } else if (upperValue.includes('M')) {
                multiplier = 1000000;  // Million
                value = upperValue.replace('M', '').trim();
            }
            
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return 0;
            
            return numValue * multiplier;
        }

        function formatMarketCap(value) {
            if (value >= 1000000000000) {
                return '$' + (value / 1000000000000).toFixed(2) + 'T';
            } else if (value >= 1000000000) {
                return '$' + (value / 1000000000).toFixed(2) + 'B';
            } else if (value >= 1000000) {
                return '$' + (value / 1000000).toFixed(2) + 'M';
            }
            return '$' + value.toFixed(0);
        }

        // Simple treemap algorithm (squarified)
        function squarify(data, x, y, width, height) {
            const total = data.reduce((sum, d) => sum + d.value, 0);
            
            function layoutRow(row, x, y, width, height) {
                const rowTotal = row.reduce((sum, d) => sum + d.value, 0);
                const rowRatio = rowTotal / total;
                
                if (width >= height) {
                    // Horizontal layout
                    const rowWidth = width * rowRatio;
                    let currentY = y;
                    row.forEach(item => {
                        const itemHeight = height * (item.value / rowTotal);
                        item.bounds = { x, y: currentY, width: rowWidth, height: itemHeight };
                        currentY += itemHeight;
                    });
                    return { x: x + rowWidth, y, width: width - rowWidth, height };
                } else {
                    // Vertical layout
                    const rowHeight = height * rowRatio;
                    let currentX = x;
                    row.forEach(item => {
                        const itemWidth = width * (item.value / rowTotal);
                        item.bounds = { x: currentX, y, width: itemWidth, height: rowHeight };
                        currentX += itemWidth;
                    });
                    return { x, y: y + rowHeight, width, height: height - rowHeight };
                }
            }

            const sorted = [...data].sort((a, b) => b.value - a.value);
            let remaining = { x, y, width, height };
            
            for (let i = 0; i < sorted.length; i++) {
                const item = sorted[i];
                item.bounds = { x: remaining.x, y: remaining.y, width: remaining.width, height: remaining.height };
                
                if (i < sorted.length - 1) {
                    remaining = layoutRow([item], remaining.x, remaining.y, remaining.width, remaining.height);
                }
            }
            
            return sorted;
        }

        function createTreemap(csvData) {
            document.getElementById('loading').style.display = 'none';
            const container = document.getElementById('container');
            container.innerHTML = '';
            
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            console.log('CSV Data received:', csvData);
            console.log('First row:', csvData[0]);
            console.log('Available columns:', Object.keys(csvData[0] || {}));
            
            // Find column names (case insensitive)
            const firstRow = csvData[0] || {};
            const cols = Object.keys(firstRow);
            
            const countryCol = cols.find(c => c.toLowerCase().includes('country')) || cols[0];
            const marketCapCol = cols.find(c => c.toLowerCase().includes('marketcap') || (c.toLowerCase().includes('market') && c.toLowerCase().includes('cap')));
            const changeCol = cols.find(c => c.toLowerCase().includes('change') || c.toLowerCase().includes('1d'));
            const percentCol = cols.find(c => c.includes('%') || c.toLowerCase().includes('percent') || c.toLowerCase().includes('global'));
            
            console.log('Detected columns:', { countryCol, marketCapCol, changeCol, percentCol });
            
            // Process data
            const processedData = csvData.map(d => {
                const marketCapValue = parseMarketCap(d[marketCapCol] || '0');
                
                // Get percentage from CSV column
                let percentValue = parseFloat(d[percentCol] || '0');
                
                return {
                    country: d[countryCol] || 'Unknown',
                    marketCap: marketCapValue,
                    change: d[changeCol] || '0%',
                    percent: percentValue,
                    value: percentValue  // USE PERCENTAGE FOR SIZING, not market cap!
                };
            }).filter(d => d.marketCap > 0 && d.percent > 0);
            
            console.log('Processed Data:', processedData);
            console.log('Valid countries:', processedData.length);
            
            if (processedData.length === 0) {
                container.innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;">No valid data found in CSV</div>';
                return;
            }
            
            // Create treemap
            const laid = squarify(processedData, 0, 0, width, height);
            
            // Create cells
            laid.forEach(d => {
                const cell = document.createElement('div');
                cell.className = 'country-cell';
                
                const bounds = d.bounds;
                cell.style.left = bounds.x + 'px';
                cell.style.top = bounds.y + 'px';
                cell.style.width = bounds.width + 'px';
                cell.style.height = bounds.height + 'px';
                cell.style.backgroundColor = getColor(d.change);
                
                const minDim = Math.min(bounds.width, bounds.height);
                const showDetails = minDim > 60;
                const showTicker = minDim > 40;
                
                let content = '';
                
                if (showDetails) {
                    content = `
                        <div class="flag">${getFlag(d.country)}</div>
                        <div class="country-ticker">${d.country.substring(0, 4).toUpperCase()}</div>
                        <div class="country-change">${d.change}</div>
                        <div class="country-value">${formatMarketCap(d.marketCap)}</div>
                        <div class="country-percent">${d.percent.toFixed(2)}%</div>
                    `;
                } else if (showTicker) {
                    content = `
                        <div class="country-ticker" style="font-size: ${Math.max(minDim * 0.25, 10)}px">${d.country.substring(0, 3)}</div>
                        <div class="country-change" style="font-size: ${Math.max(minDim * 0.2, 8)}px">${d.change}</div>
                    `;
                } else {
                    content = `<div style="font-size: ${Math.max(minDim * 0.3, 8)}px">${d.country.substring(0, 2)}</div>`;
                }
                
                cell.innerHTML = content;
                
                cell.addEventListener('click', () => {
                    alert(`${d.country}\nMarket Cap: ${formatMarketCap(d.marketCap)}\nChange: ${d.change}\nGlobal Share: ${d.percent.toFixed(2)}%`);
                });
                
                container.appendChild(cell);
            });
            
            // Update stats
            const total = processedData.reduce((sum, d) => sum + d.marketCap, 0);
            const avgChange = processedData.reduce((sum, d) => {
                const change = parseFloat(String(d.change).replace('%', ''));
                return sum + (isNaN(change) ? 0 : change);
            }, 0) / processedData.length;
            
            document.getElementById('stats').innerHTML = `
                <strong>Global Market Cap:</strong> ${formatMarketCap(total)}<br>
                <strong>Countries:</strong> ${processedData.length}<br>
                <strong>Avg Change:</strong> ${avgChange.toFixed(2)}%
            `;
        }

        // Simple CSV parser
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = values[i] || '';
                });
                return obj;
            });
        }

        // File upload handler
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const csvData = parseCSV(event.target.result);
                createTreemap(csvData);
            };
            reader.readAsText(file);
        });

        // Auto-load CSV - try multiple methods
        
        // Method 1: Try relative path (works if hosted on GitHub Pages)
        fetch('./data/countries_marketcap.csv')
            .then(response => {
                if (!response.ok) throw new Error('Relative path failed');
                console.log('Loaded via relative path');
                return response.text();
            })
            .then(csvText => {
                const csvData = parseCSV(csvText);
                createTreemap(csvData);
            })
            .catch(error1 => {
                console.log('Relative path failed, trying CDN...');
                
                // Method 2: Try jsdelivr CDN
                fetch('https://cdn.jsdelivr.net/gh/ayeeff/marketcap@main/data/countries_marketcap.csv')
                    .then(response => {
                        if (!response.ok) throw new Error('CDN failed');
                        console.log('Loaded via jsdelivr CDN');
                        return response.text();
                    })
                    .then(csvText => {
                        const csvData = parseCSV(csvText);
                        createTreemap(csvData);
                    })
                    .catch(error2 => {
                        console.log('CDN failed, trying CORS proxy...');
                        
                        // Method 3: Try with CORS proxy
                        fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://raw.githubusercontent.com/ayeeff/marketcap/main/data/countries_marketcap.csv'))
                            .then(response => response.text())
                            .then(csvText => {
                                console.log('Loaded via CORS proxy');
                                const csvData = parseCSV(csvText);
                                createTreemap(csvData);
                            })
                            .catch(error3 => {
                                console.error('All methods failed');
                                document.getElementById('loading').innerHTML = 
                                    '<strong>Could not auto-load data from GitHub.</strong><br><br>' +
                                    'Please upload CSV file using button above.<br><br>' +
                                    '<small>Make sure this HTML is hosted on GitHub Pages,<br>' +
                                    'or use the file upload button.</small>';
                            });
                    });
            });
    </script>
</body>
</html>
