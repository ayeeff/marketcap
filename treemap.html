<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Global Market Cap & Economic Visualizations</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        .map-section {
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 0;
            background: white;
            margin-bottom: 20px;
        }
        .map-header {
            max-width: 80vw;
            margin-bottom: 30px;
            text-align: center;
        }
        .map-header h2 {
            margin: 0 0 12px 0;
            font-size: 28px;
            color: #222;
            font-weight: 600;
        }
        .map-header p {
            margin: 0;
            font-size: 15px;
            color: #666;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }
        .map-container {
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #first-map {
            height: 500px;
        }
        #second-map, #third-map, #fourth-map {
            height: 400px;
        }
        .container {
            width: 80vw;
            height: 100%;
            max-width: 80vw;
        }
        svg {
            display: block;
            width: 100%;
            height: 100%;
            background: white;
        }
        .label {
            fill: black;
            font-weight: bold;
            text-anchor: start;
            dominant-baseline: central;
        }
        .treemap-g {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="map-section">
        <div class="map-header">
            <h2>Global Stock Market Capitalization by Country</h2>
            <p>Visualizing the distribution of global equity market value across nations. The size of each rectangle represents the country's share of total world market capitalization, showing the concentration of financial power in developed markets.</p>
        </div>
        <div class="map-container" id="first-map">
            <div class="container">
                <svg viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
        </div>
    </div>
    
    <div class="map-section">
        <div class="map-header">
            <h2>Empire Market Capitalization Comparison</h2>
            <p>Comparing three economic empires by their combined stock market value: Empire 1.0 (British Commonwealth), Empire 2.0 (United States), and Empire 3.0 (China + Hong Kong + Taiwan). This shows the evolution of global economic dominance through the lens of capital markets.</p>
        </div>
        <div class="map-container" id="second-map">
            <div class="container">
                <svg viewBox="0 0 1200 400" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
        </div>
    </div>
    
    <div class="map-section">
        <div class="map-header">
            <h2>Empire GDP (PPP) Comparison</h2>
            <p>Economic output measured by Purchasing Power Parity GDP, which adjusts for cost of living differences. This metric reveals the real productive capacity of each economic bloc, often diverging from nominal GDP or market cap figures.</p>
        </div>
        <div class="map-container" id="third-map">
            <div class="container">
                <svg viewBox="0 0 1200 400" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
        </div>
    </div>
    
    <div class="map-section">
        <div class="map-header">
            <h2>Empire R&D Expenditure</h2>
            <p>Total research and development spending across each empire, a key indicator of future innovation capacity and technological competitiveness. R&D investment today determines tomorrow's economic leadership.</p>
        </div>
        <div class="map-container" id="fourth-map">
            <div class="container">
                <svg viewBox="0 0 1200 400" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
        </div>
    </div>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const countryToISO = {
            "Afghanistan": "af", "Aland Islands": "ax", "Albania": "al", "Algeria": "dz",
            "American Samoa": "as", "Andorra": "ad", "Angola": "ao", "Anguilla": "ai",
            "Antarctica": "aq", "Antigua And Barbuda": "ag", "Argentina": "ar", "Armenia": "am",
            "Aruba": "aw", "Australia": "au", "Austria": "at", "Azerbaijan": "az",
            "Bahamas": "bs", "Bahrain": "bh", "Bangladesh": "bd", "Barbados": "bb",
            "Belarus": "by", "Belgium": "be", "Belize": "bz", "Benin": "bj",
            "Bermuda": "bm", "Bhutan": "bt", "Bolivia": "bo", "Bosnia And Herzegovina": "ba",
            "Botswana": "bw", "Bouvet Island": "bv", "Brazil": "br", "British Indian Ocean Territory": "io",
            "Brunei Darussalam": "bn", "Bulgaria": "bg", "Burkina Faso": "bf", "Burundi": "bi",
            "Cambodia": "kh", "Cameroon": "cm", "Canada": "ca", "Cape Verde": "cv",
            "Cayman Islands": "ky", "Central African Republic": "cf", "Chad": "td", "Chile": "cl",
            "China": "cn", "Christmas Island": "cx", "Cocos (Keeling) Islands": "cc", "Colombia": "co",
            "Comoros": "km", "Congo": "cg", "Congo, Democratic Republic": "cd", "Cook Islands": "ck",
            "Costa Rica": "cr", "Cote D' Ivoire": "ci", "Croatia": "hr", "Cuba": "cu",
            "Cyprus": "cy", "Czech Republic": "cz", "Denmark": "dk", "Djibouti": "dj",
            "Dominica": "dm", "Dominican Republic": "do", "Ecuador": "ec", "Egypt": "eg",
            "El Salvador": "sv", "Equatorial Guinea": "gq", "Eritrea": "er", "Estonia": "ee",
            "Ethiopia": "et", "Falkland Islands (Malvinas)": "fk", "Faroe Islands": "fo", "Fiji": "fj",
            "Finland": "fi", "France": "fr", "French Guiana": "gf", "French Polynesia": "pf",
            "French Southern Territories": "tf", "Gabon": "ga", "Gambia": "gm", "Georgia": "ge",
            "Germany": "de", "Ghana": "gh", "Gibraltar": "gi", "Greece": "gr",
            "Greenland": "gl", "Grenada": "gd", "Guadeloupe": "gp", "Guam": "gu",
            "Guatemala": "gt", "Guernsey": "gg", "Guinea": "gn", "Guinea-Bissau": "gw",
            "Guyana": "gy", "Haiti": "ht", "Heard Island & Mcdonald Islands": "hm", "Holy See (Vatican City State)": "va",
            "Honduras": "hn", "Hong Kong": "hk", "Hungary": "hu", "Iceland": "is",
            "India": "in", "Indonesia": "id", "Iran, Islamic Republic Of": "ir", "Iraq": "iq",
            "Ireland": "ie", "Isle Of Man": "im", "Israel": "il", "Italy": "it",
            "Jamaica": "jm", "Japan": "jp", "Jersey": "je", "Jordan": "jo",
            "Kazakhstan": "kz", "Kenya": "ke", "Kiribati": "ki", "Korea": "kr",
            "Kuwait": "kw", "Kyrgyzstan": "kg", "Lao People's Democratic Republic": "la", "Latvia": "lv",
            "Lebanon": "lb", "Lesotho": "ls", "Liberia": "lr", "Libyan Arab Jamahiriya": "ly",
            "Liechtenstein": "li", "Lithuania": "lt", "Luxembourg": "lu", "Macao": "mo",
            "Macedonia": "mk", "Madagascar": "mg", "Malawi": "mw", "Malaysia": "my",
            "Maldives": "mv", "Mali": "ml", "Malta": "mt", "Marshall Islands": "mh",
            "Martinique": "mq", "Mauritania": "mr", "Mauritius": "mu", "Mayotte": "yt",
            "Mexico": "mx", "Micronesia, Federated States Of": "fm", "Moldova": "md", "Monaco": "mc",
            "Mongolia": "mn", "Montenegro": "me", "Montserrat": "ms", "Morocco": "ma",
            "Mozambique": "mz", "Myanmar": "mm", "Namibia": "na", "Nauru": "nr",
            "Nepal": "np", "Netherlands": "nl", "Netherlands Antilles": "an", "New Caledonia": "nc",
            "New Zealand": "nz", "Nicaragua": "ni", "Niger": "ne", "Nigeria": "ng",
            "Niue": "nu", "Norfolk Island": "nf", "Northern Mariana Islands": "mp", "Norway": "no",
            "Oman": "om", "Pakistan": "pk", "Palau": "pw", "Palestinian Territory, Occupied": "ps",
            "Panama": "pa", "Papua New Guinea": "pg", "Paraguay": "py", "Peru": "pe",
            "Philippines": "ph", "Pitcairn": "pn", "Poland": "pl", "Portugal": "pt",
            "Puerto Rico": "pr", "Qatar": "qa", "Reunion": "re", "Romania": "ro",
            "Russian Federation": "ru", "Rwanda": "rw", "Saint Barthelemy": "bl", "Saint Helena": "sh",
            "Saint Kitts And Nevis": "kn", "Saint Lucia": "lc", "Saint Martin": "mf", "Saint Pierre And Miquelon": "pm",
            "Saint Vincent And Grenadines": "vc", "Samoa": "ws", "San Marino": "sm", "Sao Tome And Principe": "st",
            "Saudi Arabia": "sa", "Senegal": "sn", "Serbia": "rs", "Seychelles": "sc",
            "Sierra Leone": "sl", "Singapore": "sg", "Slovakia": "sk", "Slovenia": "si",
            "Solomon Islands": "sb", "Somalia": "so", "South Africa": "za", "South Georgia And Sandwich Isl.": "gs",
            "Spain": "es", "Sri Lanka": "lk", "Sudan": "sd", "Suriname": "sr",
            "Svalbard And Jan Mayen": "sj", "Swaziland": "sz", "Sweden": "se", "Switzerland": "ch",
            "Syrian Arab Republic": "sy", "Taiwan": "tw", "Tajikistan": "tj", "Tanzania": "tz",
            "Thailand": "th", "Timor-Leste": "tl", "Togo": "tg", "Tokelau": "tk",
            "Tonga": "to", "Trinidad And Tobago": "tt", "Tunisia": "tn", "Turkey": "tr",
            "Turkmenistan": "tm", "Turks And Caicos Islands": "tc", "Tuvalu": "tv", "Uganda": "ug",
            "Ukraine": "ua", "United Arab Emirates": "ae", "United Kingdom": "gb", "United States": "us",
            "United States Outlying Islands": "um", "Uruguay": "uy", "Uzbekistan": "uz", "Vanuatu": "vu",
            "Venezuela": "ve", "Viet Nam": "vn", "Virgin Islands, British": "vg", "Virgin Islands, U.S.": "vi",
            "Wallis And Futuna": "wf", "Western Sahara": "eh", "Yemen": "ye", "Zambia": "zm",
            "Zimbabwe": "zw", "South Korea": "kr", "Russia": "ru", "Vietnam": "vn",
            "Ivory Coast": "ci", "Palestine": "ps", "Eswatini": "sz"
        };

        const cacheBust = Date.now();

        const empireDescriptions = {
            '1': { empire: 'Empire 1.0: Steam & Colonies', desc: 'British Commonwealth', totalLabel: 'Total Market Cap' },
            '2': { empire: 'Empire 2.0: Oil & Silicon', desc: 'United States', totalLabel: 'Total Market Cap' },
            '3': { empire: 'Empire 3.0: Rare Earths, Renewables & Robotics', desc: 'China + Hong Kong + Taiwan', totalLabel: 'Total Market Cap' }
        };

        function createBarChart(svgSelector, data, totalLabel = 'Total') {
            const viewWidth = 1200;
            const viewHeight = 400;
            const margin = { top: 40, right: 40, bottom: 100, left: 80 };
            const chartWidth = viewWidth - margin.left - margin.right;
            const chartHeight = viewHeight - margin.top - margin.bottom;

            const svg = d3.select(svgSelector);
            svg.selectAll("*").remove();

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .domain(data.map((d, i) => i))
                .range([0, chartWidth])
                .padding(0.25);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.perc)])
                .nice()
                .range([chartHeight, 0]);

            const bars = g.selectAll(".bar")
                .data(data)
                .join("g")
                .attr("class", "bar")
                .attr("transform", (d, i) => `translate(${x(i)},0)`)
                .style("cursor", "pointer");

            const defs = svg.append("defs");
            data.forEach((d, i) => {
                const pattern = defs.append("pattern")
                    .attr("id", `img-pattern-${i}-${svgSelector.replace(/[^a-z0-9]/gi, '')}`)
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("patternContentUnits", "objectBoundingBox");

                let rank = d['empire#'] || d.Rank;
                if (rank) {
                    rank = rank.toString().replace('.0', '');
                    rank = parseInt(rank, 10);
                }

                pattern.append("image")
                    .attr("xlink:href", `https://raw.githubusercontent.com/ayeeff/marketcap/main/img/emp${rank || 1}.png?v=${cacheBust}`)
                    .attr("width", 1)
                    .attr("height", 1)
                    .attr("preserveAspectRatio", "xMidYMid slice");
            });

            bars.append("rect")
                .attr("x", 0)
                .attr("y", d => y(d.perc))
                .attr("width", x.bandwidth())
                .attr("height", d => chartHeight - y(d.perc))
                .attr("fill", (d, i) => `url(#img-pattern-${i}-${svgSelector.replace(/[^a-z0-9]/gi, '')})`)
                .attr("stroke", "#333")
                .attr("stroke-width", 2)
                .attr("rx", 4);

            bars.append("text")
                .attr("x", x.bandwidth() / 2)
                .attr("y", chartHeight + 20)
                .attr("text-anchor", "middle")
                .attr("font-size", "13px")
                .attr("font-weight", "600")
                .attr("fill", "#333")
                .text(d => d.Empire)
                .call(wrap, x.bandwidth());

            bars.append("text")
                .attr("x", x.bandwidth() / 2)
                .attr("y", d => y(d.perc) - 8)
                .attr("text-anchor", "middle")
                .attr("font-size", "18px")
                .attr("font-weight", "bold")
                .attr("fill", "#000")
                .text(d => `${d.perc.toFixed(1)}%`);

            const yAxis = d3.axisLeft(y)
                .ticks(5)
                .tickFormat(d => `${d}%`);

            g.append("g")
                .attr("class", "y-axis")
                .call(yAxis)
                .selectAll("text")
                .attr("font-size", "12px");

            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -55)
                .attr("x", -chartHeight / 2)
                .attr("text-anchor", "middle")
                .attr("font-size", "14px")
                .attr("font-weight", "600")
                .attr("fill", "#333")
                .text("Percentage (%)");

            const tooltipId = `tooltip-bar-${svgSelector.replace(/[^a-z0-9]/gi, '')}`;
            let tooltip = d3.select(`#${tooltipId}`);
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("id", tooltipId)
                    .style("position", "absolute")
                    .style("background", "rgba(0, 0, 0, 0.9)")
                    .style("color", "white")
                    .style("padding", "12px 16px")
                    .style("border-radius", "6px")
                    .style("pointer-events", "none")
                    .style("opacity", 0)
                    .style("font-size", "13px")
                    .style("z-index", 1000)
                    .style("box-shadow", "0 4px 6px rgba(0,0,0,0.3)");
            }

            bars.on("mouseover", function(event, d) {
                d3.select(this).select("rect")
                    .attr("stroke-width", 4)
                    .attr("stroke", "#000");
                
                tooltip.style("opacity", 1)
                    .html(`<strong>${d.Empire}</strong><br/>${d.Description}<br/>${totalLabel}: ${d.Total}<br/>Share: ${d.perc.toFixed(2)}%`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                d3.select(this).select("rect")
                    .attr("stroke-width", 2)
                    .attr("stroke", "#333");
                
                tooltip.style("opacity", 0);
            });

            function wrap(text, width) {
                text.each(function() {
                    const t = d3.select(this);
                    const words = t.text().split(/\s+/).reverse();
                    let word;
                    let line = [];
                    let lineNumber = 0;
                    const lineHeight = 1.1;
                    const y = t.attr("y");
                    const dy = 0;
                    let tspan = t.text(null).append("tspan").attr("x", t.attr("x")).attr("y", y).attr("dy", dy + "em");
                    
                    while (word = words.pop()) {
                        line.push(word);
                        tspan.text(line.join(" "));
                        if (tspan.node().getComputedTextLength() > width) {
                            line.pop();
                            tspan.text(line.join(" "));
                            line = [word];
                            tspan = t.append("tspan").attr("x", t.attr("x")).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                        }
                    }
                });
            }
        }

        function createTreemap(svgSelector, data, isEmpire = false, totalLabel = 'Total') {
            const root = d3.hierarchy({children: data})
                .sum(d => d.perc)
                .sort((a, b) => b.value - a.value);

            const viewWidth = 1200;
            const viewHeight = 800;

            const svg = d3.select(svgSelector);

            const treemap = d3.treemap()
                .size([viewWidth, viewHeight])
                .padding(1)
                .round(true);

            treemap(root);

            const leaf = svg.selectAll("g")
                .data(root.leaves())
                .join("g")
                .attr("transform", d => `translate(${Math.round(d.x0)}, ${Math.round(d.y0)})`);

            leaf.append("rect")
                .attr("width", d => Math.max(1, Math.round(d.x1 - d.x0)))
                .attr("height", d => Math.max(1, Math.round(d.y1 - d.y0)))
                .attr("fill", "none")
                .style("stroke", "#000")
                .style("stroke-width", 0.5);

            leaf.append("image")
                .attr("xlink:href", d => {
                    const country = d.data["Country or region"];
                    let iso = countryToISO[country];
                    if (!iso) return null;
                    return `https://flagcdn.com/w320/${iso}.png`;
                })
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", d => Math.max(1, Math.round(d.x1 - d.x0)))
                .attr("height", d => Math.max(1, Math.round(d.y1 - d.y0)))
                .attr("preserveAspectRatio", "none");

            const text = leaf.append("text")
                .attr("font-size", d => Math.min((d.x1 - d.x0) / 8, (d.y1 - d.y0) / 8, 12))
                .attr("fill", "black")
                .classed("label", true);

            text.append("tspan")
                .attr("x", 2)
                .attr("y", 12)
                .text(d => {
                    const name = d.data["Country or region"];
                    const shortName = name.length > 10 ? name.substring(0, 10) + '...' : name;
                    return shortName;
                });

            leaf.classed("treemap-g", true);

            const tooltipId = 'tooltip-global';
            let tooltip = d3.select(`#${tooltipId}`);
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("id", tooltipId)
                    .style("position", "absolute")
                    .style("background", "rgba(0, 0, 0, 0.9)")
                    .style("color", "white")
                    .style("padding", "12px 16px")
                    .style("border-radius", "6px")
                    .style("pointer-events", "none")
                    .style("opacity", 0)
                    .style("font-size", "13px")
                    .style("z-index", 1000)
                    .style("box-shadow", "0 4px 6px rgba(0,0,0,0.3)");
            }

            leaf.on("mouseover", (event, d) => {
                const rect = event.currentTarget.querySelector("rect");
                d3.select(rect).style("stroke-width", 2);
                const name = d.data["Country or region"];
                const cap = d.data["Total MarketCap"];
                tooltip.style("opacity", 1)
                    .html(`<strong>${name}</strong><br/>Market Cap: ${cap}<br/>Share: ${d.data.perc.toFixed(2)}%`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }).on("mouseout", (event) => {
                const rect = event.currentTarget.querySelector("rect");
                d3.select(rect).style("stroke-width", 0.5);
                tooltip.style("opacity", 0);
            });
        }

        d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/countries_marketcap.csv?v=${cacheBust}`).then(globalData => {
            console.log("Global data loaded:", globalData.length, "rows");
            globalData.forEach(d => {
                d.perc = +d["% of Global Market Cap"];
            });

            const filteredGlobal = globalData.filter(d => d.perc > 0).sort((a, b) => b.perc - a.perc);
            console.log("Filtered global data:", filteredGlobal.length, "rows");

            createTreemap("#first-map .container svg", filteredGlobal, false);

            d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/empire_marketcap.csv?v=${cacheBust}`).then(empData => {
                console.log("Empire data loaded:", empData.length, "rows");
                empData.forEach(d => {
                    let percStr = d["% of Empire Total"].toString().replace('%', '').trim();
                    d.perc = +percStr;
                    const num = d.Rank.toString();
                    const desc = empireDescriptions[num];
                    if (desc) {
                        d.Empire = desc.empire;
                        d.Description = desc.desc;
                        let totalStr = d['Total Market Cap'].toString().replace('$', '').trim();
                        d.Total = totalStr;
                    }
                    console.log(`Empire ${d.Rank}: ${d["% of Empire Total"]} -> ${d.perc}`);
                });

                const filteredEmp = empData.filter(d => +d.Rank <= 3 && !isNaN(d.perc)).sort((a, b) => +a.Rank - +b.Rank);

                createBarChart("#second-map .container svg", filteredEmp, 'Total Market Cap');
            }).catch(error => {
                console.error("Error loading empire CSV:", error);
                d3.select("body").append("p").text("Error loading empire data. Check console.");
            });

            d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/empire_gdp_ppp_2025.csv?v=${cacheBust}`).then(gdpData => {
                console.log("GDP data loaded:", gdpData.length, "rows");
                gdpData.forEach(d => {
                    d.perc = +d['%'];
                    const num = d['empire#'].replace('.0', '');
                    const desc = empireDescriptions[num];
                    if (desc) {
                        d.Empire = desc.empire;
                        d.Description = desc.desc;
                        const trillions = (d.total / 1000).toFixed(1);
                        d.Total = `${trillions}T PPP`;
                    }
                });

                createBarChart("#third-map .container svg", gdpData, 'Total GDP PPP');
            }).catch(error => {
                console.error("Error loading GDP CSV:", error);
                d3.select("body").append("p").text("Error loading GDP data. Check console.");
            });

            d3.csv(`https://raw.githubusercontent.com/ayeeff/marketcap/main/data/empire_rd_expenditure_latest.csv?v=${cacheBust}`).then(rdData => {
                console.log("R&D data loaded:", rdData.length, "rows");
                rdData.forEach(d => {
                    d.perc = +d['%'];
                    const num = d['empire#'].replace('.0', '');
                    const desc = empireDescriptions[num];
                    if (desc) {
                        d.Empire = desc.empire;
                        d.Description = desc.desc;
                        d.Total = `${(+d.total).toFixed(1)}B USD`;
                    }
                });

                createBarChart("#fourth-map .container svg", rdData, 'Total R&D');
            }).catch(error => {
                console.error("Error loading R&D CSV:", error);
                d3.select("body").append("p").text("Error loading R&D data. Check console.");
            });

        }).catch(error => {
            console.error("Error loading global CSV:", error);
            d3.select("body").append("p").text("Error loading global data. Check console.");
        });
    </script>
</body>
</html>
