let companies=[];let institutions=[];let marketCapTotals=[];let rdExpenditures=[];let gdpData=[];let citiesData=[];const empireShortNames={1:'Empire 1.0: Steam & Colonies',2:'Empire 2.0: Oil & Silicon',3:'Empire 3.0: Rare Earths, Renewables & Robotics'};const GITHUB_BASE='https://raw.githubusercontent.com/ayeeff/marketcap/main/data/';const hsrEmpireInfo={1:{name:'Steam & Colonies',color:'#3b82f6',symbol:'ðŸš‚'},2:{name:'Oil & Silicon',color:'#ef4444',symbol:'ðŸ›¢ï¸'},3:{name:'Rare Earths, Renewables & Robotics',color:'#10b981',symbol:'ðŸ¤–'}};const metroEmpireInfo={'1':{name:'Steam Era',color:'#3b82f6',fullName:'Empire 1.0: Steam & Colonies'},'2':{name:'Oil Era',color:'#ef4444',fullName:'Empire 2.0: Oil & Silicon'},'3':{name:'Tech Era',color:'#22c55e',fullName:'Empire 3.0: Rare Earths & Robotics'}};const railEmpireInfo={'1':{name:'Steam & Colonies',color:'#3b82f6',symbol:'ðŸš‚'},'2':{name:'Oil & Silicon',color:'#ef4444',symbol:'ðŸ›¢ï¸'},'3':{name:'Rare Earths, Renewables & Robotics',color:'#10b981',symbol:'ðŸ¤–'}};const countryNameToIso={'united states':'us','usa':'us','united kingdom':'gb','uk':'gb','china':'cn','peoples republic of china':'cn','jp':'jp','japan':'jp','germany':'de','france':'fr','australia':'au','canada':'ca','india':'in','russia':'ru','brazil':'br','south korea':'kr','korea, south':'kr','italy':'it','spain':'es','netherlands':'nl','saudi arabia':'sa','uae':'ae','united arab emirates':'ae','singapore':'sg','sweden':'se','switzerland':'ch','norway':'no','mexico':'mx','indonesia':'id','turkey':'tr','argentina':'ar','south africa':'za','poland':'pl','belgium':'be','ireland':'ie','israel':'il','hong kong':'hk','taiwan':'tw','vietnam':'vn','malaysia':'my','america':'us','united states of america':'us','united states':'us'};function getIsoFromCountry(countryRaw){if(!countryRaw)return null;const c=String(countryRaw).trim();if(/^[A-Za-z]{2}$/.test(c))return c.toLowerCase();const lower=c.toLowerCase();if(countryNameToIso[lower])return countryNameToIso[lower];const m=c.match(/\(([^)]+)\)/);if(m&&/^[A-Za-z]{2}$/.test(m[1]))return m[1].toLowerCase();return c.slice(0,2).toLowerCase()}
function flagUrlForCountry(countryRaw){const iso=getIsoFromCountry(countryRaw);if(!iso)return'';return `https://flagcdn.com/${iso}.svg`}
async function loadData(){try{const companiesResponse=await fetch(GITHUB_BASE+'empire_top_companies.csv');const companiesData=await companiesResponse.text();const companiesParsed=Papa.parse(companiesData,{header:!0,skipEmptyLines:!0,dynamicTyping:!1});companies=companiesParsed.data.map(row=>{const companyName=(row.Company||'').split('\n')[0].trim();const ticker=(row.Company||'').split('\n')[1]?.trim()||'';return{empire:parseInt(row.Empire),name:companyName,ticker:ticker,marketCap:row['Market Cap']||row.Market_Cap||'',country:row.Country||row.country||row.CountryCode||row.Country_Code||''}});const researchResponse=await fetch(GITHUB_BASE+'empire_research.csv');const researchData=await researchResponse.text();const researchParsed=Papa.parse(researchData,{header:!0,skipEmptyLines:!0,dynamicTyping:!0});institutions=researchParsed.data.map(row=>({empire:parseInt(row.Empire),rank:parseInt(row.Empire_Rank),name:row.Institution,globalRank:parseInt(row.Global_Rank)||null,researchShare:parseFloat(row['Research Share'])||0,country:row.Country||row.country||row.CountryCode||row.Country_Code||''}));const marketCapResponse=await fetch(GITHUB_BASE+'empire_totals.csv');const marketCapData=await marketCapResponse.text();const marketCapParsed=Papa.parse(marketCapData,{header:!0,skipEmptyLines:!0,dynamicTyping:!1});marketCapTotals=marketCapParsed.data.map(row=>({empire:parseInt(row.Empire),total:row['Total Market Cap'],share:row.Share,date:row.Date}));const rdResponse=await fetch(GITHUB_BASE+'empire_nature_share.csv');const rdData=await rdResponse.text();const rdParsed=Papa.parse(rdData,{header:!0,skipEmptyLines:!0,dynamicTyping:!0});rdExpenditures=rdParsed.data.map(row=>({empire:parseInt(row.empire),share:parseFloat(row.share_2024),percent:parseFloat(row.percent)}));const gdpResponse=await fetch(GITHUB_BASE+'empire_gdp_ppp_2025.csv');const gdpDataText=await gdpResponse.text();const gdpParsed=Papa.parse(gdpDataText,{header:!0,skipEmptyLines:!0,dynamicTyping:!0});gdpData=gdpParsed.data.map(row=>({empire:parseFloat(row['empire#']),total:parseFloat(row.total),percent:parseFloat(row['%'])}));const citiesResponse=await fetch(GITHUB_BASE+'empire_cities_population.csv');const citiesDataText=await citiesResponse.text();const citiesParsed=Papa.parse(citiesDataText,{header:!0,skipEmptyLines:!0,dynamicTyping:!0});citiesData=citiesParsed.data.map(row=>({empire:parseInt(row.Empire),rank:parseInt(row.Rank),city:row.City,country:row.Country,population:parseInt(row.Population),date:row.Scraped_Date}));initDashboard()}catch(error){console.error('Error loading data:',error);document.body.innerHTML+=`<div style="color: red; text-align: center; padding: 20px;">Error loading data: ${error.message}</div>`}}
function createLeaderPanel(containerId,sortedData){const container=document.getElementById(containerId);container.innerHTML='';sortedData.forEach((item,index)=>{const wrapper=document.createElement('div');wrapper.className=`empire-wrapper ${index === 0 ? 'gold-bg' : index === 1 ? 'silver-bg' : 'bronze-bg'}`;const rankDiv=document.createElement('div');rankDiv.className='rank-number';rankDiv.textContent=index+1;wrapper.appendChild(rankDiv);const img=document.createElement('img');img.src=`https://raw.githubusercontent.com/ayeeff/marketcap/refs/heads/main/img/emp${item.empire}.png`;img.alt=`${empireShortNames[item.empire]}`;img.className='empire-img w-72 h-72 object-contain';wrapper.appendChild(img);if(index<sortedData.length-1)wrapper.style.marginRight='-20px';container.appendChild(wrapper)})}
function makeFlagImg(country){const url=flagUrlForCountry(country);if(!url)return'';return `<img src="${url}" class="flag-img" alt="${country || ''}" onerror="this.style.display='none'"/>`}
function populateMarketTable(empireNum){const tableBody=document.getElementById(`marketEmpire${empireNum}Table`);tableBody.innerHTML='';const empireCompanies=companies.filter(c=>c.empire===empireNum);empireCompanies.forEach((company,index)=>{const flag=makeFlagImg(company.country);const row=document.createElement('tr');row.className='table-row border-b border-slate-700/50';row.innerHTML=`
            <td class="py-1 text-slate-300 text-xs">${index + 1}</td>
            <td class="py-1 text-xs break-words max-w-32"><span class="name-with-flag">${flag}${company.name}</span></td>
            <td class="py-1 text-right font-mono text-green-400 text-xs">${company.marketCap}</td>
        `;tableBody.appendChild(row)})}
function populateResearchTable(empireNum){const tableBody=document.getElementById(`researchEmpire${empireNum}Table`);tableBody.innerHTML='';const empireInstitutions=institutions.filter(i=>i.empire===empireNum).sort((a,b)=>a.globalRank-b.globalRank);empireInstitutions.forEach((inst)=>{const flag=makeFlagImg(inst.country);const row=document.createElement('tr');row.className='table-row border-b border-slate-700/50';row.innerHTML=`
            <td class="py-1 text-slate-300 text-xs">${inst.globalRank || 'â€”'}</td>
            <td class="py-1 text-xs break-words max-w-32"><span class="name-with-flag">${flag}${inst.name}</span></td>
            <td class="py-1 text-right font-mono text-purple-400 text-xs">${inst.researchShare}</td>
        `;tableBody.appendChild(row)})}
function populateCitiesTable(empireNum){const tableBody=document.getElementById(`citiesEmpire${empireNum}Table`);tableBody.innerHTML='';const empireCities=citiesData.filter(c=>c.empire===empireNum).sort((a,b)=>a.rank-b.rank).slice(0,10);empireCities.forEach((city)=>{const flag=makeFlagImg(city.country);const row=document.createElement('tr');row.className='table-row border-b border-slate-700/50';row.innerHTML=`
            <td class="py-1 text-slate-300 text-xs">${city.rank}</td>
            <td class="py-1 text-xs break-words max-w-32"><span class="name-with-flag">${flag}${city.city}</span></td>
            <td class="py-1 text-right font-mono text-yellow-400 text-xs">${city.population.toLocaleString()}</td>
        `;tableBody.appendChild(row)})}
function createInfoCard(containerId,sectionTitle,data,color,sources=[]){const pieDiv=document.getElementById(containerId);const gridParent=pieDiv.parentElement;pieDiv.remove();const newContainer=document.createElement('div');newContainer.className='grid grid-cols-1 md:grid-cols-2 gap-6';const infoDiv=document.createElement('div');infoDiv.className='speed-card rounded-2xl p-6 flex flex-col justify-start';const header=document.createElement('h3');header.className='text-slate-300 font-bold mb-4 orbitron';header.textContent=sectionTitle;infoDiv.appendChild(header);const table=document.createElement('table');table.className='w-full text-sm text-left text-white';const thead=document.createElement('thead');const headerRow=document.createElement('tr');headerRow.innerHTML=`
        <th class="text-slate-400 font-semibold pb-2">Empire</th>
        <th class="text-slate-400 font-semibold pb-2 text-right">Value</th>
        <th class="text-slate-400 font-semibold pb-2 text-right">Share</th>
    `;thead.appendChild(headerRow);table.appendChild(thead);const tbody=document.createElement('tbody');data.forEach(item=>{const tr=document.createElement('tr');tr.className='table-row border-b border-slate-700/50';tr.innerHTML=`
            <td class="py-1">${item.name}</td>
            <td class="py-1 text-right text-${color}-400 font-mono">${item.value}</td>
            <td class="py-1 text-right text-slate-300">${item.percent}%</td>
        `;tbody.appendChild(tr)});table.appendChild(tbody);infoDiv.appendChild(table);if(sources.length>0){const sourceDiv=document.createElement('div');sourceDiv.className='text-sm text-slate-500 mt-4 pt-3 border-t border-slate-700';let sourceText='';if(sources.length===1){sourceText=`Source: <a href="${sources[0]}" class="text-blue-400 hover:text-blue-300" target="_blank">${sources[0]}</a>`}else{sourceText=sources.map(src=>`Source: <a href="${src}" class="text-blue-400 hover:text-blue-300" target="_blank">${src}</a>`).join('<br>')}
sourceDiv.innerHTML=sourceText;infoDiv.appendChild(sourceDiv)}
newContainer.appendChild(infoDiv);newContainer.appendChild(pieDiv);gridParent.parentNode.replaceChild(newContainer,gridParent);return newContainer}
function initDashboard(){const marketCapRanking=[...marketCapTotals].sort((a,b)=>{const aValue=parseFloat(String(a.total).replace(/[^0-9.-]+/g,''))||0;const bValue=parseFloat(String(b.total).replace(/[^0-9.-]+/g,''))||0;return bValue-aValue});const researchRanking=[...rdExpenditures].sort((a,b)=>b.percent-a.percent);const gdpRanking=[...gdpData].sort((a,b)=>b.percent-a.percent);createLeaderPanel('marketCapLeaderPanel',marketCapRanking);createLeaderPanel('researchLeaderPanel',researchRanking);createLeaderPanel('gdpLeaderPanel',gdpRanking);[1,2,3].forEach(empire=>{populateMarketTable(empire);populateResearchTable(empire);populateCitiesTable(empire)});const marketCapContainer=createInfoCard('marketCapPie','Market Share by Empire',marketCapTotals.map(item=>({name:`Empire ${item.empire}.0`,value:item.total,percent:item.share?item.share.replace('%',''):'0.0'})),'green',['https://www.marketcapwatch.com/all-countries/']);const rdContainer=createInfoCard('rdPie','Research Share by Empire',rdExpenditures.map(item=>({name:`Empire ${item.empire}.0`,value:`${item.share?.toLocaleString?.() || item.share} research outputs`,percent:item.percent.toFixed(1)})),'purple',['https://www.nature.com/nature-index/research-leaders/2025/institution/all/all/global']);const gdpContainer=createInfoCard('gdpPie','GDP Share by Empire',gdpData.map(item=>({name:`Empire ${item.empire}.0`,value:`$${item.total?.toLocaleString?.() || item.total} B`,percent:item.percent.toFixed(1)})),'green',['https://en.wikipedia.org/wiki/List_of_countries_by_GDP_(PPP)','https://worldpopulationreview.com/cities']);const marketCapData=[{values:marketCapRanking.map(item=>parseFloat(String(item.total).replace(/[^0-9.-]+/g,''))||0),labels:marketCapRanking.map(item=>`${empireShortNames[item.empire]}\n${item.total}`),type:'pie',marker:{colors:marketCapRanking.map(item=>item.empire===1?'#f59e0b':item.empire===2?'#3b82f6':item.empire===3?'#ef4444':'#6b7280'),line:{color:'#1e293b',width:2}},textinfo:'none',textposition:'inside',textfont:{size:13,color:'#ffffff',family:'sans-serif'},hovertemplate:'<b>%{label}</b><br>%{percent}<extra></extra>'}];const rdData=[{values:researchRanking.map(item=>item.share),labels:researchRanking.map(item=>`${empireShortNames[item.empire]}\n${item.share?.toLocaleString?.()||item.share} outputs (${item.percent}%)`),type:'pie',marker:{colors:researchRanking.map(item=>item.empire===1?'#f59e0b':item.empire===2?'#3b82f6':item.empire===3?'#ef4444':'#6b7280'),line:{color:'#1e293b',width:2}},textinfo:'none',textposition:'inside',textfont:{size:12,color:'#ffffff',family:'sans-serif'},hovertemplate:'<b>%{label}</b><extra></extra>'}];const gdpDataChart=[{values:gdpRanking.map(item=>item.total),labels:gdpRanking.map(item=>`${empireShortNames[item.empire]}\n$${item.total?.toLocaleString?.()||item.total}B (${item.percent}%)`),type:'pie',marker:{colors:gdpRanking.map(item=>item.empire===1?'#f59e0b':item.empire===2?'#3b82f6':item.empire===3?'#ef4444':'#6b7280'),line:{color:'#1e293b',width:2}},textinfo:'none',textposition:'inside',textfont:{size:12,color:'#ffffff',family:'sans-serif'},hovertemplate:'<b>%{label}</b><extra></extra>'}];const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',showlegend:!1,margin:{t:10,b:10,l:10,r:10},height:280};const config={responsive:!0,displayModeBar:!1};Plotly.newPlot(marketCapContainer.querySelector('#marketCapPie'),marketCapData,layout,config);Plotly.newPlot(rdContainer.querySelector('#rdPie'),rdData,layout,config);Plotly.newPlot(gdpContainer.querySelector('#gdpPie'),gdpDataChart,layout,config)}
document.addEventListener('DOMContentLoaded',function(){const tabButtons=document.querySelectorAll('.tab-button');const tabContents=document.querySelectorAll('.tab-content');tabButtons.forEach(button=>{button.addEventListener('click',()=>{const tab=button.dataset.tab;tabButtons.forEach(btn=>btn.classList.remove('active'));button.classList.add('active');tabContents.forEach(content=>content.classList.remove('active'));document.getElementById(tab).classList.add('active');if(tab==='hsr'&&!window.hsrDataLoaded){initHSR()}
if(tab==='metro'&&!window.metroDataLoaded){initMetro()}
if(tab==='rail'&&!window.railDataLoaded){initRail()}})});initHSR();loadData()});async function loadHSRData(){try{const response=await fetch(GITHUB_BASE+'empire_hsr.csv');const csvText=await response.text();const parsed=Papa.parse(csvText,{header:!0,skipEmptyLines:!0,dynamicTyping:!0});return parsed.data.filter(row=>row.Empire&&row.Country&&row.Line&&row.Length_km>0).map(row=>({empire:parseInt(row.Empire),country:row.Country,line:row.Line,length:parseFloat(row.Length_km)}))}catch(error){console.error('Error loading HSR data:',error);return[]}}
function updateHSRSummaryCards(data){const empireLengths=['1','2','3'].map(empire=>{const empireData=data.filter(d=>d.empire.toString()===empire);return empireData.reduce((sum,d)=>sum+d.length,0)});const maxLength=Math.max(...empireLengths);['1','2','3'].forEach(empire=>{const empireData=data.filter(d=>d.empire.toString()===empire);const totalLength=empireData.reduce((sum,d)=>sum+d.length,0);const lineCount=empireData.length;const countries=new Set(empireData.map(d=>d.country)).size;document.getElementById(`hsr-empire${empire}-total`).textContent=totalLength.toLocaleString();document.getElementById(`hsr-empire${empire}-lines`).textContent=lineCount;document.getElementById(`hsr-empire${empire}-countries`).textContent=countries;const barElement=document.getElementById(`hsr-empire${empire}-bar`);const barWidth=(totalLength/maxLength)*100;setTimeout(()=>barElement.style.width=barWidth+'%',500)})}
function createHSRTotalLengthChart(data){const empireData=['1','2','3'].map(empire=>{const filtered=data.filter(d=>d.empire.toString()===empire);const total=filtered.reduce((sum,d)=>sum+d.length,0);return{empire,total,name:hsrEmpireInfo[parseInt(empire)].name,color:hsrEmpireInfo[parseInt(empire)].color}});const trace={x:empireData.map(d=>d.name),y:empireData.map(d=>d.total),type:'bar',marker:{color:empireData.map(d=>d.color),line:{color:'rgba(255,255,255,0.3)',width:2}},text:empireData.map(d=>d.total.toLocaleString()+' km'),textposition:'outside',textfont:{color:'white',size:16,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'white',family:'Inter'},xaxis:{showgrid:!1,tickfont:{size:12}},yaxis:{showgrid:!0,gridcolor:'rgba(255,255,255,0.05)',title:{text:'Total Length (km)',font:{family:'Orbitron'}}},margin:{t:20,r:20,b:60,l:70},height:350};Plotly.newPlot('hsr-totalLengthChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createHSRDistributionChart(data){const empireData=['1','2','3'].map(empire=>{const filtered=data.filter(d=>d.empire.toString()===empire);const total=filtered.reduce((sum,d)=>sum+d.length,0);return{empire,total,name:hsrEmpireInfo[parseInt(empire)].name,color:hsrEmpireInfo[parseInt(empire)].color}});const trace={labels:empireData.map(d=>d.name),values:empireData.map(d=>d.total),type:'pie',marker:{colors:empireData.map(d=>d.color),line:{color:'#1e293b',width:3}},textinfo:'label+percent',textfont:{color:'white',size:13,family:'Orbitron'},hovertemplate:'<b>%{label}</b><br>%{value:,.0f} km<br>%{percent}<extra></extra>',hole:0.4};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'white',family:'Inter'},showlegend:!1,margin:{t:20,r:20,b:20,l:20},height:350};Plotly.newPlot('hsr-distributionChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createHSRTopLinesChart(data){const sortedData=[...data].sort((a,b)=>b.length-a.length).slice(0,20);const trace={x:sortedData.map(d=>d.length),y:sortedData.map(d=>`${d.line}`.substring(0,50)),type:'bar',orientation:'h',marker:{color:sortedData.map(d=>hsrEmpireInfo[d.empire].color),line:{color:'rgba(255,255,255,0.2)',width:1}},text:sortedData.map(d=>d.length.toLocaleString()+' km'),textposition:'outside',textfont:{color:'white',size:11,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'white',family:'Inter',size:10},xaxis:{showgrid:!0,gridcolor:'rgba(255,255,255,0.05)',title:{text:'Length (km)',font:{family:'Orbitron'}}},yaxis:{showgrid:!1,automargin:!0},margin:{t:20,r:100,b:60,l:250},height:600};Plotly.newPlot('hsr-topLinesChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createHSRCountryChart(data){const countryData={};data.forEach(d=>{if(!countryData[d.country]){countryData[d.country]={total:0,empire:d.empire,country:d.country}}
countryData[d.country].total+=d.length});const sortedCountries=Object.values(countryData).sort((a,b)=>b.total-a.total);const trace={x:sortedCountries.map(d=>d.country),y:sortedCountries.map(d=>d.total),type:'bar',marker:{color:sortedCountries.map(d=>hsrEmpireInfo[d.empire].color),line:{color:'rgba(255,255,255,0.2)',width:1}},text:sortedCountries.map(d=>d.total.toLocaleString()+' km'),textposition:'outside',textfont:{color:'white',size:12,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'white',family:'Inter'},xaxis:{showgrid:!1,tickangle:-45,tickfont:{size:11}},yaxis:{showgrid:!0,gridcolor:'rgba(255,255,255,0.05)',title:{text:'Total HSR Length (km)',font:{family:'Orbitron'}}},margin:{t:20,r:20,b:120,l:70},height:450};Plotly.newPlot('hsr-countryChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createHSRDataTable(data){const tbody=document.getElementById('hsr-tableBody');const sortedData=[...data].sort((a,b)=>b.length-a.length);sortedData.forEach(row=>{const tr=document.createElement('tr');tr.className='border-b border-slate-800 hover:bg-white/5 transition-colors';tr.innerHTML=`
            <td class="py-4 px-4">
                <span class="inline-flex items-center gap-2">
                    <span class="text-xl">${hsrEmpireInfo[row.empire].symbol}</span>
                    <span class="font-mono">${row.empire}</span>
                </span>
            </td>
            <td class="py-4 px-4 font-medium">${row.country}</td>
            <td class="py-4 px-4 text-slate-300">${row.line}</td>
            <td class="py-4 px-4 text-right font-mono text-lg" style="color: ${hsrEmpireInfo[row.empire].color}">
                ${row.length.toLocaleString()}
            </td>
        `;tbody.appendChild(tr)})}
function initHSR(){loadHSRData().then(data=>{if(data.length===0){console.error('No HSR data loaded');return}
console.log(`Loaded ${data.length} HSR lines`);updateHSRSummaryCards(data);createHSRTotalLengthChart(data);createHSRDistributionChart(data);createHSRTopLinesChart(data);createHSRCountryChart(data);createHSRDataTable(data);window.hsrDataLoaded=!0})}
async function loadMetroData(){try{const metroresponse=await fetch(GITHUB_BASE+'empire_metro.csv');const csvText=await metroresponse.text();const lines=csvText.trim().split('\n');const data=[];for(let i=1;i<lines.length;i++){const line=lines[i];const values=[];let current='';let inQuotes=!1;for(let j=0;j<line.length;j++){const char=line[j];if(char==='"'){inQuotes=!inQuotes}else if(char===','&&!inQuotes){values.push(current);current=''}else{current+=char}}
values.push(current);if(values.length>=5){data.push({empire:values[0].trim(),country:values[1].trim(),city:values[2].trim(),name:values[3].trim()||values[2].trim(),length:parseFloat(values[4])||0})}}
return data}catch(error){console.error('Error loading metro data:',error);return[]}}
function animateNumber(element,target){const duration=1500;const start=0;const startTime=performance.now();function update(currentTime){const elapsed=currentTime-startTime;const progress=Math.min(elapsed/duration,1);const current=Math.floor(start+(target-start)*progress);element.textContent=current.toLocaleString();if(progress<1){requestAnimationFrame(update)}}
requestAnimationFrame(update)}
function updateMetroSummaryCards(data){['1','2','3'].forEach(empire=>{const empireData=data.filter(d=>d.empire===empire);const totalLength=empireData.reduce((sum,d)=>sum+d.length,0);const cities=new Set(empireData.map(d=>d.city)).size;const totalEl=document.getElementById(`metro-empire${empire}-total`);const citiesEl=document.getElementById(`metro-empire${empire}-cities`);animateNumber(totalEl,Math.round(totalLength));animateNumber(citiesEl,cities)})}
function createMetroTotalLengthChart(data){const empireData=['1','2','3'].map(empire=>{const filtered=data.filter(d=>d.empire===empire);const total=filtered.reduce((sum,d)=>sum+d.length,0);return{empire:empire,total:total,name:metroEmpireInfo[empire].name,color:metroEmpireInfo[empire].color}});const trace={x:empireData.map(d=>d.name),y:empireData.map(d=>d.total),type:'bar',marker:{color:empireData.map(d=>d.color),line:{color:'rgba(0, 255, 255, 0.4)',width:2}},text:empireData.map(d=>d.total.toLocaleString()+' km'),textposition:'outside',textfont:{color:'#00ffff',size:14,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'#00ffff',family:'Rajdhani'},xaxis:{showgrid:!1,color:'#00ffff'},yaxis:{showgrid:!0,gridcolor:'rgba(0, 255, 255, 0.1)',title:{text:'Total Length (km)',font:{color:'#00ffff'}}},margin:{t:20,r:20,b:60,l:60},height:300};Plotly.newPlot('metro-totalLengthChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createMetroDistributionChart(data){const empireData=['1','2','3'].map(empire=>{const filtered=data.filter(d=>d.empire===empire);const total=filtered.reduce((sum,d)=>sum+d.length,0);return{empire:empire,total:total,name:metroEmpireInfo[empire].name,color:metroEmpireInfo[empire].color}});const trace={labels:empireData.map(d=>d.name),values:empireData.map(d=>d.total),type:'pie',marker:{colors:empireData.map(d=>d.color),line:{color:'rgba(0, 255, 255, 0.3)',width:2}},textinfo:'label+percent',textfont:{color:'white',size:12,family:'Rajdhani'},hovertemplate:'<b>%{label}</b><br>%{value:,.0f} km<br>%{percent}<extra></extra>'};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'#00ffff',family:'Rajdhani'},showlegend:!1,margin:{t:20,r:20,b:20,l:20},height:300};Plotly.newPlot('metro-distributionChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createMetroTopCitiesChart(data){const sortedData=[...data].sort((a,b)=>b.length-a.length).slice(0,15);const trace={x:sortedData.map(d=>d.length),y:sortedData.map(d=>`${d.city}, ${d.country}`),type:'bar',orientation:'h',marker:{color:sortedData.map(d=>metroEmpireInfo[d.empire].color),line:{color:'rgba(0, 255, 255, 0.3)',width:1}},text:sortedData.map(d=>d.length.toLocaleString()+' km'),textposition:'outside',textfont:{color:'#00ffff',size:11,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'#00ffff',family:'Rajdhani',size:11},xaxis:{showgrid:!0,gridcolor:'rgba(0, 255, 255, 0.1)',title:{text:'Length (km)',font:{color:'#00ffff'}}},yaxis:{showgrid:!1,automargin:!0},margin:{t:20,r:100,b:60,l:200},height:500};Plotly.newPlot('metro-topCitiesChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createMetroCountryChart(data){const countryData={};data.forEach(d=>{if(!countryData[d.country]){countryData[d.country]={total:0,empire:d.empire,country:d.country}}
countryData[d.country].total+=d.length});const sortedCountries=Object.values(countryData).sort((a,b)=>b.total-a.total).slice(0,20);const trace={x:sortedCountries.map(d=>d.country),y:sortedCountries.map(d=>d.total),type:'bar',marker:{color:sortedCountries.map(d=>metroEmpireInfo[d.empire].color),line:{color:'rgba(0, 255, 255, 0.3)',width:1}},text:sortedCountries.map(d=>d.total.toLocaleString()+' km'),textposition:'outside',textfont:{color:'#00ffff',size:11,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'#00ffff',family:'Rajdhani'},xaxis:{showgrid:!1,tickangle:-45,color:'#00ffff'},yaxis:{showgrid:!0,gridcolor:'rgba(0, 255, 255, 0.1)',title:{text:'Total Metro Length (km)',font:{color:'#00ffff'}}},margin:{t:20,r:20,b:120,l:60},height:400};Plotly.newPlot('metro-countryChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createMetroDataTable(data){const tbody=document.getElementById('metro-tableBody');const sortedData=[...data].sort((a,b)=>b.length-a.length);sortedData.forEach(row=>{const tr=document.createElement('tr');tr.className='border-b border-cyan-500/10 hover:bg-cyan-500/5';tr.innerHTML=`
            <td class="py-4 px-4">
                <span class="status-indicator pulse-dot" style="background-color: ${metroEmpireInfo[row.empire].color}"></span>
                <span class="font-mono text-cyan-300">${row.empire}</span>
            </td>
            <td class="py-4 px-4 text-slate-300">${row.country}</td>
            <td class="py-4 px-4 font-semibold text-cyan-200">${row.city}</td>
            <td class="py-4 px-4 text-slate-400">${row.name}</td>
            <td class="py-4 px-4 text-right metric-display text-cyan-400">${row.length.toLocaleString()}</td>
        `;tbody.appendChild(tr)})}
function initMetro(){loadMetroData().then(data=>{if(data.length===0){console.error('No metro data loaded');return}
console.log(`Loaded ${data.length} metro systems`);updateMetroSummaryCards(data);createMetroTotalLengthChart(data);createMetroDistributionChart(data);createMetroTopCitiesChart(data);createMetroCountryChart(data);createMetroDataTable(data);window.metroDataLoaded=!0})}
async function loadRailData(){try{const railresponse=await fetch(GITHUB_BASE+'empire_rail.csv');const csvText=await railresponse.text();const lines=csvText.trim().split('\n');const data=lines.slice(1).map(line=>{const values=line.split(',');if(values.length<5)return null;return{empire:values[0].trim(),country:values[1].trim(),city:values[2].trim(),line:values[3].trim(),length:parseFloat(values[4])||0}}).filter(d=>d!==null&&d.length>0);return data}catch(error){console.error('Error loading rail data:',error);return[]}}
function updateRailSummaryCards(data){const empireLengths=['1','2','3'].map(empire=>{const empireData=data.filter(d=>d.empire===empire);return empireData.reduce((sum,d)=>sum+d.length,0)});const maxLength=Math.max(...empireLengths);['1','2','3'].forEach(empire=>{const empireData=data.filter(d=>d.empire===empire);const totalLength=empireData.reduce((sum,d)=>sum+d.length,0);const lineCount=empireData.length;const countries=new Set(empireData.map(d=>d.country)).size;document.getElementById(`rail-empire${empire}-total`).textContent=totalLength.toLocaleString(undefined,{maximumFractionDigits:0});document.getElementById(`rail-empire${empire}-lines`).textContent=lineCount;document.getElementById(`rail-empire${empire}-countries`).textContent=countries;const barElement=document.getElementById(`rail-empire${empire}-bar`);const barWidth=(totalLength/maxLength*100);setTimeout(()=>{barElement.style.width=barWidth+'%'},500)})}
function createRailTotalLengthChart(data){const empireData=['1','2','3'].map(empire=>{const filtered=data.filter(d=>d.empire===empire);const total=filtered.reduce((sum,d)=>sum+d.length,0);return{empire,total,name:railEmpireInfo[empire].name,color:railEmpireInfo[empire].color}});const trace={x:empireData.map(d=>d.name),y:empireData.map(d=>d.total),type:'bar',marker:{color:empireData.map(d=>d.color),line:{color:'rgba(255,255,255,0.3)',width:2}},text:empireData.map(d=>d.total.toLocaleString()+' km'),textposition:'outside',textfont:{color:'white',size:16,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'white',family:'Inter'},xaxis:{showgrid:!1,tickfont:{size:12}},yaxis:{showgrid:!0,gridcolor:'rgba(255,255,255,0.05)',title:{text:'Total Length (km)',font:{family:'Orbitron'}}},margin:{t:20,r:20,b:60,l:70},height:350};Plotly.newPlot('rail-totalLengthChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createRailDistributionChart(data){const empireData=['1','2','3'].map(empire=>{const filtered=data.filter(d=>d.empire===empire);const total=filtered.reduce((sum,d)=>sum+d.length,0);return{empire,total,name:railEmpireInfo[empire].name,color:railEmpireInfo[empire].color}});const trace={labels:empireData.map(d=>d.name),values:empireData.map(d=>d.total),type:'pie',marker:{colors:empireData.map(d=>d.color),line:{color:'#1e293b',width:3}},textinfo:'label+percent',textfont:{color:'white',size:13,family:'Orbitron'},hovertemplate:'<b>%{label}</b><br>%{value:,.0f} km<br>%{percent}<extra></extra>',hole:0.4};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'white',family:'Inter'},showlegend:!1,margin:{t:20,r:20,b:20,l:20},height:350};Plotly.newPlot('rail-distributionChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createRailTopLinesChart(data){const sortedData=[...data].sort((a,b)=>b.length-a.length).slice(0,20);const trace={x:sortedData.map(d=>d.length),y:sortedData.map(d=>`${d.city} - ${d.line}`.substring(0,50)),type:'bar',orientation:'h',marker:{color:sortedData.map(d=>railEmpireInfo[d.empire].color),line:{color:'rgba(255,255,255,0.2)',width:1}},text:sortedData.map(d=>d.length.toLocaleString()+' km'),textposition:'outside',textfont:{color:'white',size:11,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'white',family:'Inter',size:10},xaxis:{showgrid:!0,gridcolor:'rgba(255,255,255,0.05)',title:{text:'Length (km)',font:{family:'Orbitron'}}},yaxis:{showgrid:!1,automargin:!0},margin:{t:20,r:100,b:60,l:250},height:600};Plotly.newPlot('rail-topLinesChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createRailCountryChart(data){const countryData={};data.forEach(d=>{if(!countryData[d.country]){countryData[d.country]={total:0,empire:d.empire,country:d.country}}
countryData[d.country].total+=d.length});const sortedCountries=Object.values(countryData).sort((a,b)=>b.total-a.total);const trace={x:sortedCountries.map(d=>d.country),y:sortedCountries.map(d=>d.total),type:'bar',marker:{color:sortedCountries.map(d=>railEmpireInfo[d.empire].color),line:{color:'rgba(255,255,255,0.2)',width:1}},text:sortedCountries.map(d=>d.total.toLocaleString()+' km'),textposition:'outside',textfont:{color:'white',size:12,family:'Orbitron'}};const layout={paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',font:{color:'white',family:'Inter'},xaxis:{showgrid:!1,tickangle:-45,tickfont:{size:11}},yaxis:{showgrid:!0,gridcolor:'rgba(255,255,255,0.05)',title:{text:'Total Rail Length (km)',font:{family:'Orbitron'}}},margin:{t:20,r:20,b:120,l:70},height:450};Plotly.newPlot('rail-countryChart',[trace],layout,{responsive:!0,displayModeBar:!1})}
function createRailDataTable(data){const tbody=document.getElementById('rail-tableBody');const sortedData=[...data].sort((a,b)=>b.length-a.length);sortedData.forEach(row=>{const tr=document.createElement('tr');tr.className='border-b border-slate-800 hover:bg-white/5 transition-colors';tr.innerHTML=`
            <td class="py-4 px-4">
                <span class="inline-flex items-center gap-2">
                    <span class="text-xl">${railEmpireInfo[row.empire].symbol}</span>
                    <span class="font-mono">${row.empire}</span>
                </span>
            </td>
            <td class="py-4 px-4 font-medium">${row.country}</td>
            <td class="py-4 px-4 text-slate-300">${row.city}</td>
            <td class="py-4 px-4 text-slate-300">${row.line}</td>
            <td class="py-4 px-4 text-right font-mono text-lg" style="color: ${railEmpireInfo[row.empire].color}">
                ${row.length.toLocaleString()}
            </td>
        `;tbody.appendChild(tr)})}
function initRail(){loadRailData().then(data=>{if(data.length===0){console.error('No rail data loaded');return}
console.log(`Loaded ${data.length} rail lines`);updateRailSummaryCards(data);createRailTotalLengthChart(data);createRailDistributionChart(data);createRailTopLinesChart(data);createRailCountryChart(data);createRailDataTable(data);window.railDataLoaded=!0})}
